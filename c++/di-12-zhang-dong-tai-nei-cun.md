---
cover: >-
  https://images.unsplash.com/photo-1652599196956-248431eb0386?crop=entropy&cs=tinysrgb&fm=jpg&ixid=MnwxOTcwMjR8MHwxfHJhbmRvbXx8fHx8fHx8fDE2NTUyODQ1Mjg&ixlib=rb-1.2.1&q=80
coverY: 0
---

# ğŸ˜† ç¬¬ 12 ç«  åŠ¨æ€å†…å­˜

## ç¬¬ 12 ç«  åŠ¨æ€å†…å­˜

åŠ¨æ€å†…å­˜çš„åŠ¨æ€ä½“ç°åœ¨å“ªé‡Œï¼Œè¿˜è¦ä»æˆ‘ä»¬å‰é¢æ‰€çŸ¥é“çš„å…¨å±€å˜é‡ï¼Œå±€éƒ¨å˜é‡ï¼Œä»¥åŠ static å˜é‡è¿›è¡Œå¯¹æ¯”ï¼Œå…¨å±€å˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ¨ªç©¿æ•´ä¸ªç¨‹åºè¿è¡Œæ—¶çŸ¥é“ç¨‹åºè¿è¡Œç»“æŸï¼Œå±€éƒ¨å˜é‡éšç€è°ƒç”¨æ ˆä¸Šä¸‹æ–‡çš„ç¦»å¼€è¿›è¡Œé‡Šæ”¾ï¼Œstatic åˆå§‹åŒ–åœ¨ç¬¬ä¸€æ¬¡è¢«è¿è¡Œæ—¶å˜é‡è¢«å®šä¹‰ï¼ŒçŸ¥é“ç¨‹åºè¿è¡Œç»“æŸæ‰é‡Šæ”¾ï¼Œè€ŒåŠ¨æ€å†…å­˜å°±æ˜¯ç¼–ç äººå‘˜æ‰‹åŠ¨æ˜¾å¼çš„ç”³è¯·çš„å†…å­˜ï¼Œåªæœ‰æ˜¾å¼åœ°è¿›è¡Œé‡Šæ”¾æ‰ä¼šè¢«é‡Šæ”¾ï¼Œå¦åˆ™çŸ¥é“ç¨‹åºè¿è¡Œç»“æŸ

C è¯­è¨€ä¹Ÿæœ‰åŠ¨æ€å†…å­˜ï¼Œè€Œå…¶ä¹Ÿæ˜¯ä¸€ä»¶éå¸¸å±é™©åœ°æ˜¯äº‹æƒ…ï¼Œç»éªŒä¸è¶³çš„å¼€å‘äººå‘˜å¯èƒ½ç¼–ç é€ æˆå†…å­˜æ³„éœ²ã€‚åœ¨ C++ä¸­ï¼Œæ ‡å‡†åº“å®šä¹‰äº†ä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆç±»å‹æ¥ç®¡ç†åŠ¨æ€åˆ†é…çš„å¯¹è±¡ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åº”è¯¥è¢«é‡Šæ”¾æ—¶ï¼ŒæŒ‡å‘å®ƒçš„æ™ºèƒ½æŒ‡é’ˆå¯ä»¥ç¡®ä¿è‡ªåŠ¨åœ°é‡Šæ”¾å®ƒ

### ä¸¤ç§æ™ºèƒ½æŒ‡é’ˆ

æ–°çš„æ ‡å‡†åº“æä¾›ä¸¤ç§æ™ºèƒ½æŒ‡é’ˆç±»å‹æ¥ç®¡ç†åŠ¨æ€å¯¹è±¡ï¼Œæ™ºèƒ½æŒ‡é’ˆä¸æ™®é€šæŒ‡é’ˆç±»ä¼¼ï¼Œä½†åŒºåˆ«åœ¨äºå®ƒè´Ÿè´£è‡ªåŠ¨é‡Šæ”¾æ‰€æŒ‡å‘çš„å¯¹è±¡\
ä¸¤ç§æŒ‡é’ˆçš„åŒºåˆ«ä¹‹å¤„åœ¨äºç®¡ç†åº•å±‚æŒ‡é’ˆçš„æ–¹å¼ï¼šshared_ptr å…è®¸å¤šä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼›unique_ptr åˆ™â€œç‹¬å â€æ‰€æŒ‡å¯¹è±¡ï¼Œä¸èƒ½å†æœ‰å…¶ä»–æŒ‡é’ˆæŒ‡å‘å…¶æŒ‡çš„å¯¹è±¡\
æ ‡å‡†åº“è¿˜å®šä¹‰äº† weak_ptr çš„ä¼´éšç±»ï¼Œæ˜¯ä¸€ç§å¼±å¼•ç”¨ï¼ŒæŒ‡å‘ shared_ptr æ‰€ç®¡ç†çš„å¯¹è±¡ï¼Œå®ƒä»¬éƒ½åœ¨å¤´æ–‡ä»¶`memory`ä¸­

### shared_ptr å’Œ unique_ptr éƒ½æ”¯æŒçš„æ“ä½œ

![shared_ptrå’Œunique_ptréƒ½æ”¯æŒçš„æ“ä½œ](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-15 120951.jpg>)

```cpp
//example1.cpp
shared_ptr<string> str_ptr;      //å¯ä»¥æŒ‡å‘string
shared_ptr<vector<int>> vec_ptr; //å¯ä»¥æŒ‡å‘vector<int>
//åˆ¤æ–­æŒ‡é’ˆæ˜¯å¦ä¸ºç©º
if (str_ptr != nullptr)
{
    *str_ptr = "hello"; //è§£å¼•ç”¨
}
```

### shared_ptr ç‹¬æœ‰çš„æ“ä½œ

![shared_ptrç‹¬æœ‰çš„æ“ä½œ](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-15 121014.jpg>)

### make_shared å‡½æ•°

`make_shared<T>(args)`å‡½æ•°å°±æ˜¯ç”³è¯·å¯ä»¥ç”± shared_ptr ç®¡ç†çš„å†…å­˜,args ä¸º T çš„æ„é€ å‡½æ•°å‚æ•°

```cpp
//example2.cpp
shared_ptr<string> str_ptr = make_shared<string>("hello");
shared_ptr<string> str_ptr1 = make_shared<string>("world");
if (str_ptr)
{
    cout << *str_ptr << endl; // hello
    // get()æ–¹æ³•è·å¾—æ™®é€šæŒ‡é’ˆ
    string *ptr = str_ptr.get();
    cout << *ptr << endl; // hello
}
//äº¤æ¢æŒ‡é’ˆ
str_ptr1.swap(str_ptr);
cout << *str_ptr << " " << *str_ptr1 << endl; // world hello
//ä½¿ç”¨swapå‡½æ•°
swap(str_ptr, str_ptr1);
cout << *str_ptr << " " << *str_ptr1 << endl; // hello world
```

### shared_ptr çš„æ‹·è´å’Œèµ‹å€¼

shared_ptr åœ¨æ‹·è´æˆ–èµ‹å€¼æ—¶ï¼Œæ¯ä¸ª shared_ptr éƒ½ä¼šè®°å½•æœ‰å¤šå°‘ä¸ªå…¶ä»– shared_ptr æŒ‡å‘ç›¸åŒçš„å¯¹è±¡

shared_ptr é‡‡ç”¨å¼•ç”¨è®¡æ•°ï¼Œå½“æˆ‘ä»¬æ‹·è´ä¸€ä¸ª shared_ptrï¼Œè®¡æ•°å™¨å°±ä¼šåŠ ä¸€ï¼Œå½“ shared_ptr è¢«èµ‹äºˆæ–°çš„å€¼æ—¶æˆ–è€… shared_ptr ç¦»å¼€ä½œç”¨åŸŸï¼Œåˆ™ä¼šå°†è®¡æ•°å™¨å‡ä¸€

ä¸€æ—¦ä¸€ä¸ª shared_ptr çš„è®¡æ•°å™¨å˜ä¸º 0ï¼Œä»–å°±ä¼šé‡Šæ”¾è‡ªå·±æ‰€ç®¡ç†çš„å¯¹è±¡çš„å†…å­˜

```cpp
//example3.cpp
void m_function()
{
    shared_ptr<string> str_ptr = make_shared<string>("dynamic memory");
    //å½“ä¸Šä¸‹æ–‡ç¦»å¼€functionæ—¶ æ ˆå†…å­˜å˜é‡ str_ptråˆ™ä¼šè¢«é‡Šæ”¾é”€æ¯ åˆ™é‚£å—å†…å­˜çš„å¼•ç”¨è®¡æ•°å˜ä¸º0
    //ä¹Ÿä¼šè¢«é‡Šæ”¾æ‰
}

int main(int argc, char **argv)
{
    //make_sharedç”³è¯·çš„å†…å­˜ï¼Œå†…å­˜çš„å¼•ç”¨æ•°é‡ä¸º0
    //str_ptræŒ‡å‘ç”³è¯·çš„å†…å­˜ï¼Œå†…å­˜çš„å¼•ç”¨æ•°é‡åŠ 1
    shared_ptr<string> str_ptr = make_shared<string>("hello");
    //åˆæœ‰ä¸€ä¸ªæ–°çš„shared_ptræŒ‡å‘é‚£å—å†…å­˜ï¼Œåˆ™å¼•ç”¨è®¡æ•°+1
    shared_ptr<string> str_ptr1 = str_ptr;
    str_ptr1 = nullptr; //å¼•ç”¨è®¡æ•°å‡ä¸€
    str_ptr = nullptr;  //å¼•ç”¨è®¡æ•°å˜ä¸º0 é‚£å—å†…å­˜çš„å¼•ç”¨è®¡æ•°å˜ä¸º0 åˆ™è¿›è¡Œé‡Šæ”¾
    m_function();
    cout << "over" << endl; // over
    return 0;
}
```

### shared_ptr è‡ªåŠ¨é”€æ¯æ‰€ç®¡ç†çš„å¯¹è±¡

å› ä¸º shared_ptr è¢«é”€æ¯æ—¶ä¼šå…ˆæ‰§è¡Œå…¶ææ„å‡½æ•°ï¼Œææ„å‡½æ•°å†…åˆ¤æ–­æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœåªå‰©è‡ªå·±æœ¬èº«æŒ‡å‘å®ƒï¼Œåˆ™ä¼šå°†å¯¹è±¡é‡Šæ”¾æ‰

æ›´åŠ ç»†èŠ‚çš„äº‹æƒ…

```cpp
//example4.cpp
shared_ptr<string> m_function()
{
    shared_ptr<string> str_ptr = make_shared<string>("dynamic memory");
    return str_ptr;
    //é¦–å…ˆmake_sharedç”³è¯·çš„å†…å­˜å¼•ç”¨æ•°é‡ä¸º0
    // str_ptræŒ‡å‘å…¶å¯¹è±¡ åˆ™å¼•ç”¨æ•°é‡å˜ä¸º1
    //åé¢return å³è¿›è¡Œäº†æ‹·è´str_ptrå­˜å‚¨åˆ°ä¸´æ—¶å˜é‡ å¼•ç”¨æ•°é‡è¾¹ä¸º2
    //ä¸Šä¸‹æ–‡ç¦»å¼€str_ptré”€æ¯ å¼•ç”¨æ•°é‡å˜ä¸º1
    //å¦‚æœè°ƒç”¨è€…æ¥æ”¶äº†è¿”å›çš„å‚æ•° åˆ™å¼•ç”¨æ•°é‡å˜ä¸º2
    //ä¸´æ—¶å˜é‡è¢«é”€æ¯ å¼•ç”¨æ•°é‡å˜ä¸º1
    //å¦‚æœè°ƒç”¨è€…æ²¡æœ‰æ¥æ”¶è¿”å›çš„å‚æ•°ï¼Œåˆ™ä¸´æ—¶å˜é‡è¢«é”€æ¯ï¼Œå¼•ç”¨æ•°é‡å˜ä¸º0ï¼Œå¯¹è±¡å†…å­˜å†…é‡Šæ”¾
}

int main(int argc, char **argv)
{
    m_function();                              //å†…éƒ¨ç”³è¯·çš„å†…å­˜è¢«é‡Šæ”¾
    shared_ptr<string> str_ptr = m_function(); //å†…éƒ¨ç”³è¯·çš„å†…å­˜ä¸ä¼šè¢«é‡Šæ”¾ï¼Œå› ä¸ºæœ‰str_ptræŒ‡å‘
    cout << *str_ptr << endl;                  // dynamic memory
    return 0;
}
```

æˆ‘ä»¬ä¼šå‘ç°ï¼Œåˆç†åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆ C++ä¹Ÿå¯ä»¥åƒ Java ä¸€æ ·æ‹¥æœ‰ä¼˜ç§€çš„å†…å­˜ç®¡ç†ï¼Œè€Œä¸”æ˜¯ç›´æ¥æ“çºµå†…å­˜çº§åˆ«

### ä¸ºä»€ä¹ˆè¦ç”¨åŠ¨æ€å†…å­˜

ç¨‹åºä½¿ç”¨åŠ¨æ€å†…å­˜å‡ºäºä¸€ä¸‹ä¸‰ç§åŸå› ä¹‹ä¸€

- ç¨‹åºä¸çŸ¥é“è‡ªå·±éœ€è¦ä½¿ç”¨å¤šå°‘å¯¹è±¡
- ç¨‹åºä¸çŸ¥é“æ‰€éœ€å¯¹è±¡çš„å‡†ç¡®ç±»å‹
- ç¨‹åºéœ€è¦åœ¨å¤šä¸ªå¯¹è±¡é—´å…±äº«æ•°æ®

æœ‰è¶£å…¸å‹çš„å¤šä¸ªå¯¹è±¡å…±äº«ä¸€ä¸ªå¯¹è±¡çš„ä¾‹å­

```cpp
//example5.cpp
class Person
{
public:
    shared_ptr<string> name;
    Person() = default;
    Person(const Person &person)
    {
        name = person.name;
    }
};

int main(int argc, char **argv)
{
    Person person;
    { //å†…éƒ¨ä½œç”¨åŸŸ
        Person person1;
        person1.name = make_shared<string>("gaowanlu");
        person = person1;
        cout << *person.name << endl; // gaowanlu
        *person.name = "hi";
        cout << *person1.name << endl; // hi
        cout << *person.name << endl;  // hi
    }
    //ä½œç”¨åŸŸç¦»å¼€person1è¢«é”€æ¯ï¼Œä½†ç”³è¯·çš„å†…å­˜ä»å­˜åœ¨å¼•ç”¨è®¡æ•°
    cout << *person.name << endl; // hi
    return 0;
}
```

### ç›´æ¥ç®¡ç†å†…å­˜

å­¦è¿‡ C è¯­è¨€çš„è¯å¯ä»¥çŸ¥é“åœ¨ stdlib å¤´æ–‡ä»¶ä¸­ï¼Œæœ‰ malloc å‡½æ•°ä¸ realloc å‡½æ•°

```cpp
//example6.cpp
int *int_arr = (int *)malloc(sizeof(int) * 10);
for (int i = 0; i < 10; i++)
{
    int_arr[i] = i;
}
int_arr = (int *)realloc(int_arr, sizeof(int) * 20);
for (int i = 10; i < 20; i++)
{
    int_arr[i] = i;
}
for (int i = 0; i < 20; i++)
{
    cout << int_arr[i] << " ";
}
// 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19
cout << endl;
free(int_arr);
```

åœ¨ C++ä¸­å®šä¹‰äº†ä¸¤ä¸ªè¿ç®—ç¬¦æ¥æ˜¾å¼åœ°é…åˆ†å’Œé‡Šæ”¾å†…å­˜ï¼Œè¿ç®—ç¬¦ new ç”¨äºåˆ†é…å†…å­˜ï¼Œdelete é‡Šæ”¾ new åˆ†é…çš„å†…å­˜

### ä½¿ç”¨ new åŠ¨æ€åˆ†é…å’Œåˆå§‹åŒ–å¯¹è±¡

`Type* ptr=new Type(args)` åŠ¨æ€åˆ†é…å†…å­˜

1ã€new åŸºæœ¬ç±»å‹ä¸è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œæ€»ä¹‹ä½¿ç”¨æ„é€ å‡½æ•°

```cpp
//example7.cpp
int *p1 = new int; //æœªåˆå§‹åŒ–çš„int
*p1 = 999;
cout << *p1 << endl;       // 999
int *p2 = new int(1);      //åˆå§‹åŒ–ä¸º1
cout << *p2 << endl;       // 1
string *p3 = new string;   //åˆå§‹åŒ–ä¸ºç©ºçš„string
string *p4 = new string(); //åˆå§‹åŒ–ä¸ºç©ºçš„string
string *p5 = new string("hello");
string *p6 = new string(10, 'p'); //åˆå§‹åŒ–ä¸º10ä¸ªpçš„å­—ç¬¦ä¸²
```

2ã€new é¡ºåºå®¹å™¨

```cpp
//ä¸ä»…ä»…å¯ä»¥newåŸºæœ¬æ•°æ®ç±»å‹
vector<int> *p7 = new vector<int>{1, 2, 3, 4, 5};
for (auto &item : *p7)
{
    cout << item << " "; // 1 2 3 4 5
}
cout << endl;
```

3ã€auto æ¥æ”¶æŒ‡é’ˆ

```cpp
//ä½¿ç”¨auto
auto p8 = new string("3232"); // p8çš„ç±»å‹æ˜¯é€šè¿‡"3232"ç±»å‹æ¨æ–­å‡ºæ¥çš„
auto p9 = new vector<int>{1, 2, 3, 4, 5};
```

4ã€auto æ¨æ–­è¦ new çš„æ•°æ®ç±»å‹

```cpp
//æ›´å‰å®³çš„autoç”¨æ³•,å°½é‡ä¸è¦ç”¨ï¼ŒC++å¯æ˜¯éå¼±ç±»å‹è¯­è¨€
auto p10 = new auto(1); //æ ¹æ®1çš„ç±»å‹è‡ªåŠ¨æ¨æ–­
// auto p11 = new auto{1, 2, 3, 4};//æ‹¬å·åªèƒ½æœ‰å•ä¸ªåˆå§‹åŒ–å™¨
auto p12 = new auto{string("1")}; //æ‹¬å·å•ä¸ªåˆå§‹åŒ– std::initializer_list<string>
auto str = (*p12).begin();
cout << *str << endl; // 1
// delete p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p12;//é”™è¯¯ å†™æ³• deleteä¼˜å…ˆçº§æ¯”ï¼Œé«˜
delete p1, delete p2, delete p3, delete p4, delete p5, delete p6, delete p7, delete p8, delete p9, delete p10, delete p12;
```

### åŠ¨æ€åˆ†é…çš„ const å¯¹è±¡

ä½¿ç”¨ new åˆ†é… const å¯¹è±¡æ˜¯è¢«å…è®¸çš„

```cpp
//example8.cpp
const int *int_ptr = new const int(666); //å¿…é¡»è¢«åˆå§‹åŒ–
//*int_ptr = 999;// error: assignment of read-only location '* int_ptr'
cout << *int_ptr << endl; // 666
const string *str_ptr = new const string(10, 'p');
cout << *str_ptr << endl; // pppppppppp
delete int_ptr, delete str_ptr;
```

### å†…å­˜è€—å°½

æˆ‘ä»¬çŸ¥é“è®¡ç®—æœºçš„å†…å­˜æ˜¯æœ‰é™çš„ï¼Œæ“ä½œç³»ç»Ÿå¯¹æŸä¸ªè¿›ç¨‹å¯èƒ½ä¹Ÿå­˜åœ¨å†…å­˜çš„å¤§å°é™åˆ¶ï¼Œåœ¨æ˜¾å¼åŠ¨æ€åˆ†é…å†…å­˜æ—¶ï¼Œå¯èƒ½ä¼šåˆ†é…å¤±è´¥ï¼Œå½“åˆ†é…å¤±è´¥ï¼Œæœ‰ä¸¤ç§é€‰æ‹©

1ã€`new Type(args)`æŠ›å‡º std::bad_alloc å¼‚å¸¸\
2ã€åœ¨ä½¿ç”¨ new æ—¶`new (nothrow) Type(args)`å½¢å¼è¿›è¡Œï¼Œåˆ™åˆ†é…å¤±è´¥æ—¶è¿”å›ç©ºæŒ‡é’ˆ

bad_alloc å’Œ nothrow éƒ½å®šä¹‰åœ¨å¤´æ–‡ä»¶ new ä¸­

```cpp
//example9.cpp
int *p1 = new (nothrow) int; //åˆ†é…å¤±è´¥å¼‚å¸¸ è¿”å›ç©ºæŒ‡é’ˆ
if (p1 == nullptr)
{
    assert("å†…å­˜åˆ†é…å¤±è´¥");
}
else
{
    cout << "å†…å­˜åˆ†é…æˆåŠŸ" << endl; //å†…å­˜åˆ†é…æˆåŠŸ
    delete p1;
    p1 = nullptr;
}
try
{
    p1 = new int; //åˆ†é…å¤±è´¥æ—¶åˆ™æŠ›å‡ºå¼‚å¸¸
}
catch (std::bad_alloc e)
{
    cout << e.what() << endl;
}
if (p1)
{
    delete p1;
    p1 = nullptr;
}
```

### é‡Šæ”¾åŠ¨æ€å†…å­˜

delete è¡¨è¾¾å¼ç”¨æ¥å°†åŠ¨æ€å†…å­˜å½’è¿˜ç»™ç³»ç»Ÿ `delete ptr;` ptr å¿…é¡»æŒ‡å‘ä¸€ä¸ªåŠ¨æ€åˆ†é…çš„å¯¹è±¡æˆ–ä¸€ä¸ªç©ºæŒ‡é’ˆ

delete æ‰§è¡Œä¸¤ä¸ªåŠ¨ä½œï¼Œå¦‚æœå¯¹è±¡æœ‰ææ„å‡½æ•°åˆ™ä¼šæ‰§è¡Œææ„å‡½æ•°é”€æ¯å¯¹è±¡ï¼Œç„¶åé‡Šæ”¾å¯¹åº”çš„å†…å­˜

### æŒ‡é’ˆå€¼å’Œ delete

é‡è¦çš„æ˜¯ï¼Œdelete é‡Šæ”¾çš„å†…å­˜å¿…é¡»æ˜¯æˆ‘ä»¬ç”³è¯·çš„åŠ¨æ€å†…å­˜ï¼Œæ ˆå†…å­˜å¯ä¸èƒ½æ‰‹åŠ¨é‡Šæ”¾

```cpp
//example10.cpp
int *num = new int(99);
cout << *num << endl; // 99
delete num;
delete num;           //æœªå®šä¹‰ å› ä¸ºnumæŒ‡å‘çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾
cout << *num << endl; // 17211320
int *ptr = nullptr;
delete ptr; //é‡Šæ”¾ä¸€ä¸ªç©ºæŒ‡é’ˆæ²¡æœ‰é”™è¯¯
int stack_num = 100;
delete &stack_num;         //æœªå®šä¹‰ å› ä¸º&statck_numä¸ºæ ˆå†…å­˜
cout << stack_num << endl; // 100

const int *const_ptr = new const int(99);
delete const_ptr;
```

### åŠ¨æ€å¯¹è±¡çš„ç”Ÿå­˜å‘¨æœŸ

ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Œç®€å•åœ°è¯´å°±æ˜¯æˆ‘ä»¬ç”³è¯·äº†å†…å­˜ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŠ¨è¿‡å…¶å†…å­˜åœ°å€è¿›è¡Œè®¿é—®çš„ï¼Œä½†å¦‚æœå†…å­˜æ²¡æœ‰é‡Šæ”¾ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•è·å–å…¶åœ°å€äº†ï¼Œé‚£ä¹ˆå†…å­˜å°±ä¼šç™½ç™½è¢«å ç€ï¼ŒçŸ¥é“ç¨‹åºåœæ­¢è¿è¡Œ

å®¹æ˜“å‡ºç°çš„é”™è¯¯

```cpp
//example11.cpp
int *p = new int;
p = nullptr; //å†…å­˜æ³„éœ² å†ä¹Ÿæ‰¾ä¸å›é‚£å—å†…å­˜çš„åœ°å€

//è¢«é‡Šæ”¾ååˆä½¿ç”¨
p = new int;
int *p1 = p;
delete p1;
*p = 999;
//å¡ä½å› ä¸ºäºŒè€…æŒ‡å‘åŒä¸€å—å†…å­˜ä½†æ˜¯å·²ç»è¢«é‡Šæ”¾è¿‡äº†
//ä¸èƒ½åœ¨è¢«ä½¿ç”¨
```

æ‰€ä»¥å°½é‡åœ¨ delete ä¹‹åï¼Œå°†æŒ‡é’ˆæŒ‡å‘ nullptr å³ç©ºæŒ‡é’ˆ

```cpp
int *p=new int;
delete p;
p=nullptr;
```

### shared_ptr å’Œ new ç»“åˆä½¿ç”¨

å¦‚æœä¸åˆå§‹åŒ–ä¸€ä¸ª shared_ptr åˆ™å°†ä¼šæ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œé™¤äº† make_shared è¿˜ä»¥ä½¿ç”¨ä»¥ä¸‹å…¶ä»–æ–¹æ³•å®šä¹‰å’Œæ”¹å˜ shared_ptr

![å®šä¹‰å’Œæ”¹å˜shared_ptrçš„å…¶ä»–æ–¹æ³•](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-17 090038.jpg>)

```cpp
//example12.cpp
//è¿”å›è¿”å›
shared_ptr<int> func()
{
    // return new int(1);//é”™è¯¯ï¼šå› ä¸ºshared_ptrçš„æ„é€ å‡½æ•°æ˜¯explicitçš„
    return shared_ptr<int>(new int(1)); //æ­£ç¡®
}

int main(int argc, char **argv)
{
    int *p = new int(999);
    shared_ptr<int> ptr1(p); //æ¥ç®¡pæ‰€æŒ‡å‘çš„å¯¹è±¡
    shared_ptr<int> ptr2(new int(1));
    shared_ptr<int> ptr3 = func();
    cout << *ptr3 << endl; // 1
    return 0;
}
```

### ä¸è¦æ··åˆä½¿ç”¨æ™®é€šæŒ‡é’ˆå’Œæ™ºèƒ½æŒ‡é’ˆ

ç”± shared_ptr æ¥ç®¡çš„ new å‡ºæ¥çš„å†…å­˜ï¼Œå¦‚æœ share_ptr è‡ªåŠ¨é‡Šæ”¾äº†å®ƒï¼Œä½†æˆ‘ä»¬åˆä½¿ç”¨æ™®é€šæŒ‡é’ˆä½¿ç”¨å®ƒï¼Œåˆ™ä¼šå‡ºç°é”™è¯¯

```cpp
//example13.cpp
void func(shared_ptr<int> ptr)
{
    // use ptr
}

int main(int argc, char **argv)
{
    shared_ptr<int> ptr1 = make_shared<int>(999);
    func(ptr1);            //åœ°å€è¿›è¡Œå€¼ä¼ é€’
    cout << *ptr1 << endl; // 999
    int *ptr2(new int(666));
    func(shared_ptr<int>(ptr2));
    cout << *ptr2 << endl; // 17080272 æ¢ç  å¯è§newå‡ºæ¥çš„å¯¹è±¡è¢«é‡Šæ”¾æ‰äº†
    //ptr2å˜æˆä¸ºæ‚¬ç©ºæŒ‡é’ˆ
    return 0;
}
```

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Œå› ä¸º shared_ptr æ˜¯æŒ‰ç…§å€¼ä¼ é€’çš„ï¼Œåœ¨`func(shared_ptr<int>)(ptr2)`æ—¶å¼•ç”¨æ•°ä¸º 1ï¼Œå½“èµ‹å€¼ç»™ func çš„å½¢å‚åå¼•ç”¨æ•°ä¸º 2ï¼Œç„¶åä¼ å‚ä¸´æ—¶å˜é‡é”€æ¯å¼•ç”¨æ•°å˜ä¸º 1ï¼Œéšç€ func è¿è¡Œç»“æŸå½¢å‚ ptr è¢«é”€æ¯ï¼Œå¼•ç”¨æ•°å˜ä¸º 0ï¼Œå†…å­˜ä¹Ÿä¼šè¢«é‡Šæ”¾

### ä¸è¦ä½¿ç”¨ get åˆå§‹åŒ–å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆæˆ–æ™ºèƒ½æŒ‡é’ˆèµ‹å€¼

ç¡®å®š shared_ptr.get()å‡ºæ¥çš„æŒ‡é’ˆä¸ä¼šè¢« delete å†ä½¿ç”¨ getï¼Œæ°¸è¿œä¸è¦ç”¨ get åˆå§‹åŒ–å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆæˆ–å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆèµ‹å€¼

```cpp
//example14.cpp
int main(int argc, char **argv)
{
    shared_ptr<int> ptr1 = make_shared<int>(999);
    int *ptr2 = ptr1.get(); //è·å–å¯¹è±¡å†…å­˜çš„æ™®é€šåœ°å€
    {
        shared_ptr<int>(ptr2);
        //å› ä¸ºåœ¨æ„é€ å‡½æ•°ä¸­ ptr2åªæ˜¯è¢«è®¤ä¸ºæ˜¯newå‡ºæ¥çš„æ™®é€šçš„å†…å­˜åœ°å€
        //ä¸çŸ¥é“æ˜¯å·²ç»è¢«shared_ptræ¥ç®¡çš„
    } //éšç€ä½œç”¨åŸŸæ¶ˆå¤±ptr3è¢«é”€æ¯ å†…å­˜ä¹Ÿä¼šè¢«é‡Šæ”¾
    *ptr2 = 888;
    cout << *ptr2 << endl;
    cout << *ptr1 << endl;
    //ä½†æœ‰äº›ç¼–è¯‘å™¨è¿™äº›æ“ä½œæ˜¯æ²¡é”™è¯¯çš„
    return 0;
}
```

### å…¶ä»– shared_ptr æ“ä½œ

å¸¸ç”¨çš„æœ‰ resetã€unique æ–¹æ³•ï¼Œshared_ptr çš„ reset æ–¹æ³•ç”¨äº shared_ptr å»æ‰å¯¹å…¶æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨ï¼Œå¦‚æœ reset åå¯¹è±¡å†…å­˜å¼•ç”¨æ•°ä¸º 0 åˆ™å¯¹è±¡å†…å­˜ä¼šè¢«é‡Šæ”¾ï¼Œunique æ–¹æ³•ç”¨äºæ£€æµ‹ shared_ptr æŒ‡å‘çš„å¯¹è±¡çš„å†…å­˜å¼•ç”¨æ•°æ˜¯å¦ä¸º 1ï¼Œä¸º 1 åˆ™è¿”å› true å¦åˆ™åä¹‹ã€‚

```cpp
//example15.cpp
int main(int argc, char **argv)
{
    shared_ptr<int> ptr1 = make_shared<int>(888);
    shared_ptr<int> ptr2 = ptr1;
    //æŒ‡å‘å¯¹è±¡å†…å­˜å¼•ç”¨æ•°æ˜¯å¦ä¸º1
    cout << ptr1.unique() << endl; // 0
    ptr1.reset();
    cout << *ptr2 << endl;
    *ptr2 = 999;
    cout << *ptr2 << endl; // 999
    //å¯è§resetå°±æ˜¯å°†shared_ptrå¯¹æŒ‡å‘å¯¹è±¡å†…å­˜å¼•ç”¨æ•°å‡1
    //åŒæ—¶å¦‚æœå¼•ç”¨æ•°å˜ä¸º0ä¹Ÿä¼šè¢«é‡Šæ”¾
    cout << ptr2.unique() << endl; // 1

    shared_ptr<int> ptr3(new int(999));
    int *ptr4 = ptr3.get();
    ptr3.reset();
    cout << *ptr4 << endl; //æŒ‡é’ˆæ‚¬ç©º
    return 0;
}
```

### æ™ºèƒ½æŒ‡é’ˆå’Œå¼‚å¸¸

æœ€å¸¸è§çš„æƒ…å†µ

```cpp
//example16.cpp
void func()
{
    int *p = new int(111);
    throw std::logic_error("logic_error"); //æŠ›å‡ºå¼‚å¸¸ å¯¼è‡´deleteæ— æ³•è¢«æ‰§è¡Œ
    //è¿›è€Œé€ æˆå†…å­˜æ³„éœ²
    delete p;
}

int main(int argc, char **argv)
{
    try
    {
        func();
    }
    catch (std::logic_error e)
    {
        cout << e.what() << endl; // logic_error
    }
    cout << "over" << endl; // over
    return 0;
}
```

å½“è‡ªå®šä¹‰ç±»æ²¡æœ‰ææ„å‡½æ•°æ—¶ï¼Œä½†æ˜¯åœ¨å…¶å†…éƒ¨å­˜å‚¨äº† new çš„å†…å­˜çš„åœ°å€çš„æŒ‡é’ˆï¼Œä½†æ˜¯åœ¨ææ„å‡½æ•°æ—¶å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œé‡Šæ”¾æ“ä½œï¼Œåœ¨ä½¿ç”¨ shared_ptr ç®¡ç†æ—¶ï¼Œå½“å¯¹è±¡å†…å­˜é‡Šæ”¾ï¼Œå†…éƒ¨æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜æ— æ³•è¢«é‡Šæ”¾

```cpp
//example17.cpp
class Person
{
public:
    string *ptr;
    explicit Person()
    {
        ptr = new string("");
    }
    ~Person()
    {
        cout << "release" << endl;
        // delete ptr;
    }
};

void func()
{
    shared_ptr<Person> ptr = make_shared<Person>();
} //å†…å­˜æ³„éœ² newçš„stringæ²¡æœ‰è¢«é‡Šæ”¾

int main(int argc, char **argv)
{
    func();
    return 0;
}
```

### è‡ªå®šä¹‰åˆ é™¤å™¨

é€šè¿‡ example7.cpp æˆ‘ä»¬å¯ä»¥å‡ºæœ‰æ—¶ä¼š C++ä¹Ÿä¼šä½¿ç”¨ C çš„ä¸€äº›åº“ï¼Œåœ¨ C è¯­è¨€ä¸­æ˜¯æ²¡æœ‰ææ„å‡½æ•°ï¼Œæœ‰æ—¶å€™å°†éœ€è¦å¯¹å¯¹è±¡å†…éƒ¨é‡Šæ”¾çš„æ“ä½œï¼Œå†™ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ delete æ—¶è¿›è¡Œä½¿ç”¨

- `shared_ptr<T>p(q,d)` q ä¸º T\*,d ä¸ºè‡ªå®šä¹‰åˆ é™¤å™¨
- `shared_ptr<T>p(q,d)` q ä¸º shared_ptr\<T>ç±»å‹ï¼Œd ä¸ºè‡ªå®šä¹‰åˆ é™¤å™¨
- `p.reset(q,d)` q ä¸º T\*ï¼Œd ä¸ºè‡ªå®šä¹‰åˆ é™¤å™¨

åœ¨ C è¯­è¨€ä¸­å¸¸è§çš„æ“ä½œ

```cpp
//example18.cpp
struct Person
{
    int *ptr;
};

Person *createPerson()
{
    Person *p = (Person *)malloc(sizeof(Person));
    p->ptr = (int *)malloc(sizeof(int));
    return p;
}

void deletePerson(Person **ptr)
{
    Person *p = *ptr;
    free(p);
    *ptr = nullptr;
}

int main(int argc, char **argv)
{
    Person *p = createPerson();
    deletePerson(&p); //ä¼ é€’äºŒç»´æŒ‡é’ˆä»¥è‡³äºdeletePersonå¯ä»¥ä¿®æ”¹p
    return 0;
}
```

shared_ptr çš„è®¾è®¡è€…æ›¿æˆ‘ä»¬æƒ³åˆ°ä¼šé¢ä¸´è¿™æ ·çš„é—®é¢˜ï¼Œç¨‹åºå‘˜å¯ä»¥åœ¨å®šä¹‰ shared_ptr æ—¶ä¼ é€’åˆ é™¤å™¨(deleter),ä¹Ÿå°±æ˜¯è‡ªå®šä¹‰å‡½æ•°ä»£æ›¿ delete

```cpp
//example19.cpp
struct Person
{
    int *ptr;
    Person()
    {
        ptr = new int(888);
    }
};

void deletePerson(Person *ptr)
{
    if (ptr->ptr)
    {
        delete ptr->ptr;
        ptr->ptr = nullptr;
        cout << "delete ptr->ptr;" << endl;
    }
    delete ptr;
}

void func()
{
    shared_ptr<Person> ptr(new Person(), deletePerson); //é‡Šæ”¾æ—¶ä½¿ç”¨deletePerson
    cout << ptr.unique() << endl;                       // 1
    Person *p = new Person;
    // delete ptr->ptr;
    ptr.reset(p, deletePerson); // é‡Šæ”¾pæ—¶ä½¿ç”¨deletePerson
    // delete ptr->ptr;
}

int main(int argc, char **argv)
{
    func();                 // delete ptr->ptr
    cout << "over" << endl; // over
    return 0;
}
```

### unique_ptr

ä»åå­—ä¸Šé¢å°±èƒ½çŸ¥é“ unique_ptr ä¸ shared_ptr çš„åŒºåˆ«ï¼Œunique_ptr æŒ‡å‘çš„å¯¹è±¡åªèƒ½æœ‰ä¸€ä¸ª unique_ptr æŒ‡å‘ä¸€ä¸ªç»™å®šå¯¹è±¡ï¼Œå½“ unique_ptr é”€æ¯æ—¶å…¶æ‰€æŒ‡å‘çš„å¯¹è±¡ä¹Ÿä¼šè¢«é‡Šæ”¾

![unique_ptræ“ä½œ](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-19 080936.jpg>)

ä¸ shared_ptr æœ€å¤§åŒºåˆ«å°±æ˜¯å…¶æœ‰ release æ–¹æ³•ï¼Œå…¶å®šä¹‰æ—¶å¿…é¡»è¢«åˆå§‹åŒ–ï¼Œä¸èƒ½è¿›è¡Œæ‹·è´æˆ–è€…èµ‹å€¼ï¼Œæ²¡æœ‰ make_shared ç±»ä¼¼çš„å‡½æ•°ä½¿ç”¨åªèƒ½é…å’Œ new å’ŒæŒ‡é’ˆä½¿ç”¨

```cpp
//example20.cpp
struct Person
{
    int *ptr;
    Person()
    {
        ptr = new int(888);
    }
};

void deletePerson(Person *ptr)
{
    if (ptr->ptr)
    {
        delete ptr->ptr;
        ptr->ptr = nullptr;
        cout << "delete ptr->ptr;" << endl;
    }
    delete ptr;
}

void func1(unique_ptr<Person, decltype(deletePerson) *> u2)
{
}

void func()
{
    unique_ptr<int> u(new int(999));
    // unique_ptr<Person, decltype(deletePerson) *> u1;//é”™è¯¯ unique_ptrå¿…é¡»è¢«åˆå§‹åŒ–
    unique_ptr<Person, decltype(deletePerson) *> u2(new Person(), deletePerson);
    // unique_ptr<Person, decltype(deletePerson) *> u3 = u2; //é”™è¯¯ ä¸å…è®¸èµ‹å€¼
    // func1(u2); é”™è¯¯ //ä¸å…è®¸æ‹·è´
    u2 = nullptr;             // u2æŒ‡å‘å¯¹è±¡å†…å­˜è¢«é‡Šæ”¾
    cout << "point1" << endl; // delete ptr->ptr; point1
    u2.reset(new Person());
    Person *person = u2.release();                                         //è®©u2æ”¾å¼ƒç®¡ç†æƒ ä½†ä¸é‡Šæ”¾å†…å­˜ è¿”å›ä½œä¸ºè¿”å›å€¼è¿”å›
    unique_ptr<Person, decltype(deletePerson) *> u3(person, deletePerson); //æ–°çš„unique_ptræ¥ç®¡
    // reset
    cout << *(u3->ptr) << endl; // 888
    u3.reset(nullptr);          //é‡Šæ”¾å¹¶èµ‹ä¸ºnullptr
    cout << "point2" << endl;   // delete ptr->ptr; point2
    person = new Person();
    u3.reset(person); // reseté‡Šæ”¾åŸå†…å­˜æŒ‡å‘æ–°å†…å­˜ å½“u3è¢«é”€æ¯æ—¶è¾“å‡º delete ptr->ptr;
}

int main(int argc, char **argv)
{
    func();
    return 0;
}
```

### unique_ptr ä½œä¸ºå‡½æ•°è¿”å›ç±»å‹

æœ‰ç§æƒ…å†µæ˜¯è¢«å…è®¸è¿›è¡Œæ‹·è´çš„ï¼Œå°±æ˜¯å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯ unique_ptr ç±»å‹

ç¼–è¯‘å™¨çŸ¥é“è¦è¿”å›çš„å¯¹è±¡å°†è¦è¢«é”€æ¯ï¼Œåœ¨æ­¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æ‰§è¡Œä¸€ç§ç‰¹æ®Šçš„â€œæ‹·è´â€

```cpp
//example21.cpp
unique_ptr<string> func()
{
    unique_ptr<string> p(new string("hello"));
    return p;
}

int main(int argc, char **argv)
{
    unique_ptr<string> p = func();
    cout << *p << endl; // hello
    return 0;
}
```

### weak_ptr

æœ‰æ—¶å¯¹äº shared_ptr æˆ‘ä»¬å¯èƒ½åªæ˜¯æƒ³è®©å¦ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å…¶å†…å­˜ï¼Œä½†ä¸è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œè¿˜æ˜¯ç”±åŸæ¥çš„æŒ‡å‘å†…å­˜çš„ shared_ptr è¿›è¡Œåè°ƒç®¡ç†\
å°†ä¸€ä¸ª weak_ptr ç»‘å®šåˆ°ä¸€ä¸ª shared_ptr ä¸ä¼šæ”¹å˜ shared_ptr çš„å¼•ç”¨è®¡æ•°

![weak_ptr](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-19 084419.jpg>)

```cpp
//example22.cpp
int main(int argc, char **argv)
{
    shared_ptr<int> ptr(new int(888));
    weak_ptr<int> weak(ptr);   //æ„é€ weak_ptr
    weak_ptr<int> weak1 = ptr; //èµ‹å€¼æ„é€ 
    // shared_ptrå¼•ç”¨æ•°
    cout << weak.use_count() << " " << weak1.use_count() << endl; // 1 1
    //æŒ‡ç©º
    weak1.reset();
    cout << weak.expired() << endl; // false usecountä¸ä¸º0
    // expiredä¸ºtrueåˆ™è¿”å›ä¸€ä¸ªshared_ptr
    cout << *weak.lock() << endl; // 888
    //ä½†æ˜¯åœ¨shared_ptrè‡ªåŠ¨é‡Šæ”¾åå†æ¬¡ä½¿ç”¨weak_ptråˆ™expiredè¿”å›true use_countä¸º0
    return 0;
}
```

### new å’Œæ•°ç»„

åŠ¨æ€å†…å­˜æ•°ç»„ä¸èƒ½ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œä¸èƒ½ä½¿ç”¨ begin ä¸ end è·å–è¿­ä»£å™¨ï¼Œè¿›è€Œä¹Ÿä¸èƒ½ä½¿ç”¨èŒƒå›´ for å¾ªç¯

```cpp
//example23.cpp
int main(int argc, char **argv)
{
    int *ptr = new (nothrow) int[10];
    delete ptr;
    //ä½¿ç”¨tyedef
    typedef int arrT[100];
    ptr = new arrT;
    delete[] ptr;
    return 0;
}
```

### åˆå§‹åŒ–åŠ¨æ€æ•°ç»„

å¯ä»¥ä¸æ˜¾å¼è°ƒç”¨æ„é€ å‡½æ•°ä¼šé»˜è®¤è°ƒç”¨ï¼Œå¯ä»¥ä½¿ç”¨åˆ—è¡¨è¿›è¡Œåˆå§‹åŒ–

```cpp
//example24.cpp
int main(int argc, char **argv)
{
    int *p1 = new int[10];         // 10ä¸ªæœªåˆå§‹åŒ–çš„int
    int *p2 = new int[10]();       // 10ä¸ªåˆå§‹åŒ–ä¸º0çš„int
    string *p3 = new string[10];   // 10ä¸ªç©ºstring
    string *p4 = new string[10](); // 10ä¸ªç©ºstring
    int *p5 = new int[10]{1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
    //åˆå§‹åŒ–å‰ä¸‰ä¸ªå…ƒç´ 
    string *p6 = new string[10]{"aaa", "bbb", string(3, 'c')};
    int *p7 = nullptr;
    try
    {
        int *p7 = new int[3000]{1, 2, 3};
    }
    catch (std::bad_array_new_length e) //åˆ†é…å†…å­˜å¤±è´¥å°†ä¼šæŠ›å‡ºå¼‚å¸¸
    {
        cout << e.what() << endl;
    }
    delete[] p1, delete[] p2, delete[]  p3, delete[]  p4, delete[]  p5, delete[]  p6, delete[]  p7;
    return 0;
}
```

### åŠ¨æ€åˆ†é…ç©ºæ•°ç»„

æ²¡ä»€ä¹ˆç”¨çŸ¥é“æœ‰è¿™ç§å°±è¡Œ

```cpp
//example25.cpp
int main(int argc, char **argv)
{
    char arr[0];
    char *ptr = new char[0];
    //äºŒè€…éƒ½ä¸èƒ½è§£å¼•ç”¨
    cout << to_string((size_t)ptr) << endl;
    delete[] ptr;
    return 0;
}
```

### æ™ºèƒ½æŒ‡é’ˆå’ŒåŠ¨æ€æ•°ç»„

- åŠ¨æ€æ•°ç»„å¯ä»¥ä½¿ç”¨ unique_ptr è¿›è¡Œå†…å­˜ç®¡ç†

![æŒ‡å‘æ•°ç»„çš„unique_ptr](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-20 093304.jpg>)

```cpp
//example26.cpp
int main(int argc, char **argv)
{
    unique_ptr<int[]> ptr(new int[10]);
    ptr[0] = 1;
    cout << ptr[0] << endl;
    //å¯ä»¥æ‰‹åŠ¨é‡Šæ”¾
    ptr.reset();
    return 0;
}
```

- shared_ptr ä¸èƒ½ç›´æ¥ç®¡ç†åŠ¨æ€æ•°ç»„ï¼Œå¦‚æœéœ€è¦åˆ™éœ€è¦è‡ªå®šä¹‰åˆ é™¤å™¨

```cpp
//example27.cpp
int main(int argc, char **argv)
{
    shared_ptr<int> ptr(new int[10], [](int *p)
                        { delete[] p; });
    // shared_ptræœªå®šä¹‰ä¸‹æ ‡è¿ç®—ç¬¦ å¯ä»¥ä½¿ç”¨getè·å–çœŸå®çš„é¦–åœ°å€
    ptr.get()[9] = 666;
    cout << ptr.get()[9] << endl; // 666
    return 0;
}
```

åˆç†ä½¿ç”¨ unique_ptr ä¸ shared_ptr ç®¡ç†åŠ¨æ€æ•°ç»„ï¼Œå¯ä»¥å¤§å¤§é™ä½å†™ä»£ç çš„å¿§è™‘

### allocator ç±»

ä½¿ç”¨åŠ¨æ€å†…å­˜æ•°ç»„å®¹æ˜“å‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Œå°±æ˜¯ä¾‹å¦‚å¯èƒ½éœ€è¦æ¥è¿‘ 50 ä¸ªå·¦å³ int çš„ç©ºé—´ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”³è¯· 60 ä¸ªï¼Œä½†æ˜¯æœ‰äº›å†…å­˜ç©ºé—´æˆ‘ä»¬å§‹ç»ˆæ²¡æœ‰å†è¿›è¡Œä½¿ç”¨ï¼Œé€ æˆèµ„æºæµªè´¹ï¼Œnew ä¸å¯¹è±¡çš„æ„é€ è”ç³»åœ¨ä¸€èµ·ï¼Œdelete\[]ä¸å¯¹è±¡çš„ææ„å‡½æ•°è”ç³»åœ¨ä¸€èµ·ï¼Œallocator å°±æ˜¯è§£å†³ç±»ä¼¼çš„é—®é¢˜è€Œç”Ÿçš„

![æ ‡å‡†åº“allocatorç±»åŠå…¶ç®—æ³•](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-20 094756.jpg>)

ç®€å•ä¸Šæ‰‹

```cpp
//example28.cpp
int main(int argc, char **argv)
{
    allocator<int> a;
    int const *p = a.allocate(10); //åˆ†é…10ä¸ªintç©ºé—´
    for (int i = 0; i < 10; i++)
    {
        a.destroy(p + i); //é”€æ¯æ¯ä¸ªå¯¹è±¡æ‰§è¡Œææ„å‡½æ•°
    }
    a.deallocate((int *)p, 10);
    return 0;
}
```

### allocator åˆ†é…æœªæ„é€ çš„å†…å­˜

allocator å°±ä½œç”¨å°±æ˜¯å°†å†…å­˜ç”³è¯·ä¸å¯¹è±¡çš„æ„é€ åˆ†å¼€ï¼Œdelete ä¸ææ„å‡½æ•°çš„è°ƒç”¨ä¹Ÿåˆ†å¼€ï¼Œæœ‰åˆ©äºæ›´å¥½çš„åˆ©ç”¨å†…å­˜ç©ºé—´

```cpp
//example29.cpp
// allocate.construct(ptr,args...)
int main(int argc, char **argv)
{
    allocator<int> allocate;
    int *ptr = allocate.allocate(10);
    allocate.construct(ptr, 888); //åˆ©ç”¨ç”³è¯·çš„ç¬¬ä¸€ä¸ªå†…å­˜æ„é€ 
    allocate.construct(ptr, 999); //å†æ¬¡æ„é€ 
    cout << *ptr << endl;         // 999
    //è°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°
    allocate.destroy(ptr); //è°ƒç”¨ç¬¬ä¸€ä¸ªå†…å­˜å­˜æ”¾çš„å¯¹è±¡çš„ææ„
    //å°†10ä¸ªå†…å­˜è¿›è¡Œé‡Šæ”¾
    allocate.deallocate(ptr, 10); //é‡Šæ”¾ç”³è¯·çš„10ä¸ªå†…å­˜
    return 0;
}
```

### æ‹·è´å’Œå¡«å……æœªåˆå§‹åŒ–å†…å­˜

![allocatorç®—æ³•](<../.gitbook/assets/å±å¹•æˆªå›¾ 2022-06-20 103037.jpg>)

```cpp
//example30.cpp
void print(int arr[], int n);

int main(int argc, char **argv)
{
    allocator<int> allocate;
    constexpr int n = 10;
    int *p1 = allocate.allocate(n);
    int *p2 = allocate.allocate(n);
    for (int i = 0; i < 10; i++)
    {
        p1[i] = i;
    }

    //æ­¤æ‹·è´æ˜¯å†…å­˜çº§çš„æ‹·è´
    uninitialized_copy(p1, p1 + n, p2); //æ‹·è´åˆ°p2
    print(p2, 10);                      // 0 1 2 3 4 5 6 7 8 9
    uninitialized_copy_n(p1, 10, p2);   //ä»p1æ‹·è´10ä¸ªå†…å­˜å•ä½åˆ°p2

    // fillå¡«å……
    uninitialized_fill(p1, p1 + 10, 666);
    print(p1, 10); // 666 666 666 666 666 666 666 666 666 666
    uninitialized_fill_n(p2, 5, 666);
    print(p2, 10); // 666 666 666 666 666 5 6 7 8 9

    //å¯¹è±¡ææ„
    for (int i = 0; i < 10; i++)
    {
        allocate.destroy(p1 + i);
        allocate.destroy(p2 + i);
    }

    //å†…å­˜é‡Šæ”¾
    allocate.deallocate(p1, n);
    allocate.deallocate(p2, n);
    cout << "end" << endl; // end

    // copyå‡½æ•°çš„è¿”å›å€¼ è¿”å›æœ€åä¸€ä¸ªæ„é€ çš„å¯¹è±¡çš„åä¸€ä¸ªä½ç½®çš„åœ°å€
    p1 = allocate.allocate(10);
    p2 = allocate.allocate(10);
    p1[0] = 0, p1[1] = 2, p1[2] = 3, p1[3] = 4;
    int *temp = uninitialized_copy_n(p1, 3, p2);
    *temp = 999;
    cout << p2[3] << endl; // 999 å¯è§æ˜¯æ‹·è´è¿‡å»çš„åé¢ä¸€ä¸ªä½ç½®åœ°å€

    return 0;
}

void print(int arr[], int n)
{
    for (int i = 0; i < n; i++)
    {
        cout << arr[i] << " ";
    }
    cout << endl;
}
```
