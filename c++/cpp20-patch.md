# ğŸŒ C++20 ç‰¹æ€§

C++20 å¼•å…¥äº†è®¸å¤šæ–°ç‰¹æ€§å’Œè¯­è¨€æ”¹è¿›ï¼Œä¸‹é¢æ˜¯å…¶ä¸­ä¸€äº›ä¸»è¦çš„ç‰¹æ€§ï¼š

1ã€æ¦‚å¿µï¼ˆConceptsï¼‰ï¼šC++20 å¼•å…¥äº†æ¦‚å¿µçš„æ¦‚å¿µï¼Œå…è®¸ç¨‹åºå‘˜åœ¨ç¼–å†™æ¨¡æ¿ä»£ç æ—¶æŒ‡å®šå‚æ•°å¿…é¡»æ»¡è¶³çš„ç±»å‹çº¦æŸã€‚

2ã€æ¨¡å—ï¼ˆModulesï¼‰ï¼šC++20 å¼•å…¥äº†æ¨¡å—ï¼Œå…è®¸ç¨‹åºå‘˜å°†ä»£ç åˆ†å‰²ä¸ºé€»è¾‘å•å…ƒï¼Œå‡å°‘äº†å¤´æ–‡ä»¶åŒ…å«å¸¦æ¥çš„ç¼–è¯‘æ—¶é—´å’ŒäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ã€‚

3ã€åç¨‹ï¼ˆCoroutinesï¼‰ï¼šC++20 å¼•å…¥äº†åç¨‹ï¼Œä½¿å¾—å¼‚æ­¥ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚

4ã€åˆå§‹åŒ–åˆ—è¡¨æ„é€ å‡½æ•°æ¨¡æ¿ï¼ˆTemplate for Initialization List Constructorsï¼‰ï¼šC++20 å…è®¸ä½¿ç”¨æ¨¡æ¿å®šä¹‰åˆå§‹åŒ–åˆ—è¡¨æ„é€ å‡½æ•°ï¼Œä»è€Œæ”¯æŒæ›´å¤šçš„åˆå§‹åŒ–æ–¹å¼ã€‚

5ã€constexpr å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ä¸å†æœ‰é™åˆ¶ï¼ˆRelaxing Constraints on constexpr Functionsï¼‰ï¼šC++20 å…è®¸ constexpr å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹å¯ä»¥æ˜¯ä»»æ„çš„ï¼Œè€Œä¸å†æœ‰é™åˆ¶ã€‚

6ã€ç©ºæŒ‡é’ˆå¸¸é‡è¡¨è¾¾å¼ï¼ˆConstexpr Null Pointerï¼‰ï¼šC++20 å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ç©ºæŒ‡é’ˆå¸¸é‡è¡¨è¾¾å¼ std::nullptr_tï¼Œå…è®¸åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ›´å®‰å…¨çš„ç©ºæŒ‡é’ˆæ£€æŸ¥ã€‚

7ã€ç¼–è¯‘æ—¶å­—ç¬¦ä¸²æ“ä½œï¼ˆCompile-Time String Operationsï¼‰ï¼šC++20 å¼•å…¥äº†ç¼–è¯‘æ—¶å­—ç¬¦ä¸²æ“ä½œï¼Œå¯ä»¥åœ¨ç¼–è¯‘æ—¶è¿›è¡Œå­—ç¬¦ä¸²çš„æ‹¼æ¥ã€æˆªå–å’Œè½¬æ¢ç­‰æ“ä½œã€‚

8ã€å¤šçº¿ç¨‹åº“æ”¹è¿›ï¼ˆImprovements to the Thread Libraryï¼‰ï¼šC++20 æ”¹è¿›äº†å¤šçº¿ç¨‹åº“ï¼Œå¼•å…¥äº†ä¸€äº›æ–°çš„ç‰¹æ€§ï¼Œå¦‚åŒæ­¥é˜Ÿåˆ—ã€é”å‡çº§ã€çº¿ç¨‹å±€éƒ¨å­˜å‚¨ç­‰ã€‚

9ã€å…ƒç¼–ç¨‹æ”¹è¿›ï¼ˆImprovements to Metaprogrammingï¼‰ï¼šC++20 å¼•å…¥äº†ä¸€äº›å…ƒç¼–ç¨‹æ”¹è¿›ï¼Œå¦‚ consteval å‡½æ•°ã€requires è¡¨è¾¾å¼ã€typename åœ¨æ¨¡æ¿å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®æ›´åŠ çµæ´»ç­‰ã€‚

10ã€ä¸‰è·¯æ¯”è¾ƒæ“ä½œç¬¦

11ã€å¼‚å¸¸è§„èŒƒ

12ã€åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¼˜åŒ–

13ã€ç±»å‹ç‰¹æ€§ä¿®æ”¹å’Œå¢å¼º

14ã€std::rangesåº“

15ã€æ•è·åˆå§‹åŒ–

16ã€çº¿ç¨‹æœ¬åœ°å­˜å‚¨

17ã€ç»Ÿä¸€çš„æ„é€ å’Œææ„

18ã€æ•°å­¦åˆ†éš”ç¬¦

19ã€åŒæ­¥é˜Ÿåˆ—

20ã€å…¶ä»–ç»†èŠ‚æ”¹è¿›ï¼šC++20 è¿˜å¼•å…¥äº†ä¸€äº›å…¶ä»–çš„ç»†èŠ‚æ”¹è¿›ï¼Œå¦‚ä¸‰å‘æ¯”è¾ƒæ“ä½œç¬¦ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•° std::format()ã€std::span å®¹å™¨ã€æ ‡å‡†åº“ä¸­å¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ”¯æŒç­‰ã€‚

## ä¸‰å‘æ¯”è¾ƒ

### å¤ªç©ºé£èˆ¹ spaceship è¿ç®—ç¬¦

C++20æ ‡å‡†æ–°å¼•å…¥äº†ä¸€åä¸ºâ€œå¤ªç©ºé£èˆ¹â€(spaceship)çš„è¿ç®—ç¬¦`<=>`ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦ã€‚`<=>`å¹¶ä¸æ˜¯C++20é¦–åˆ›çš„ï¼Œå®é™…ä¸ŠPerlã€PHPã€Rubyç­‰è¯­è¨€æ—©å·²æ”¯æŒäº†ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦ï¼ŒC++æ˜¯åæ¥çš„å­¦ä¹ è€…ã€‚

```cpp
// lhs <=> rhs
// å¯èƒ½äº§ç”Ÿä¸‰ç§ç»“æœ è¯¥ç»“æœå¯ä»¥å’Œ0æ¯”è¾ƒ
// å°äº0 lhs < rhs
// ç­‰äº0 lhs == rhs
// å¤§äº0 lhs > rhs
#include <iostream>
using namespace std;

int main()
{
    bool b = 7 <=> 11 < 0;
    std::cout << b << std::endl; // 1
    return 0;
}
```

è¿ç®—ç¬¦`<=>`çš„è¿”å›å€¼åªèƒ½ä¸0å’Œè‡ªèº«ç±»å‹æ¥æ¯”è¾ƒï¼Œå¦‚æœåŒå…¶ä»–æ•°å€¼æ¯”è¾ƒï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚

```cpp
bool b = 7 <=> 11 < 100; // ç¼–è¯‘å¤±è´¥,<=>çš„ç»“æœä¸èƒ½ä¸0ä¹‹å¤–çš„æ•°å€¼æ¯”è¾ƒ
```

### ä¸‰å‘æ¯”è¾ƒçš„è¿”å›ç±»å‹

å¯ä»¥çœ‹å‡º`<=>`çš„è¿”å›ç»“æœå¹¶ä¸æ˜¯ä¸€ä¸ªæ™®é€šç±»å‹ï¼Œæ ¹æ®æ ‡å‡†ä¸‰å‘æ¯”è¾ƒä¼šè¿”å›3ç§ç±»å‹ï¼Œè€Œè¿™3ç§ç±»å‹åˆä¼šåˆ†ä¸ºæœ‰3ï½4ç§æœ€ç»ˆç»“æœã€‚

```cpp
std::strong_ordering
std::weak_ordering
std::partial_ordering
```

### std::strong_ordering

```cpp
// è¡¨è¾¾å¼ lsh <=> rhs
std::strong_ordering
    - std::strong_ordering::less    å¯¹åº” lhs  < rhs
    - std::strong_ordering::equal   å¯¹åº” lhs == rhs
    - std::strong_ordering::greater å¯¹åº” lhs  > rhs
```

`std::strong_ordering` ç±»å‹çš„ç»“æœå¼ºè°ƒçš„æ˜¯strongçš„å«ä¹‰ï¼Œè¡¨è¾¾çš„æ˜¯ä¸€ç§å¯æ›¿æ¢æ€§ï¼Œç®€å•æ¥è¯´ï¼Œè‹¥`lhs == rhs`ï¼Œé‚£ä¹ˆåœ¨ä»»ä½•æƒ…å†µä¸‹rhså’Œlhséƒ½å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¹Ÿå°±æ˜¯`fx(lhs) == fx(rhs)`ã€‚

å¯¹äºåŸºæœ¬ç±»å‹ä¸­çš„intç±»å‹ï¼Œä¸‰å‘æ¯”è¾ƒè¿”å›çš„æ˜¯`std::strong_ordering`ï¼Œä¾‹å¦‚ï¼š

```cpp
#include <iostream>

using namespace std;

int main()
{
    std::cout << typeid(decltype(7 <=> 11)).name();
    // St15strong_ordering
    return 0;
}
```

å¯¹äºæœ‰å¤æ‚ç»“æ„çš„ç±»å‹ï¼Œ`std::strong_ordering` è¦æ±‚å…¶æ•°æ®æˆå‘˜å’ŒåŸºç±»çš„ä¸‰å‘æ¯”è¾ƒç»“æœéƒ½ä¸º`std::strong_ordering`ã€‚ä¾‹å¦‚ï¼š

é»˜è®¤æƒ…å†µä¸‹è‡ªå®šä¹‰ç±»å‹æ˜¯ä¸å­˜åœ¨ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°çš„ï¼Œéœ€è¦ç”¨æˆ·æ˜¾å¼é»˜è®¤å£°æ˜ã€‚

```cpp
#include <iostream>
#include <compare>

using namespace std;

class B
{
public:
    int a;
    long b;
    auto operator <=> (const B&) const = default;
};

class D : public B
{
public:
    short c;
    auto operator <=> (const D&) const = default;
};

int main()
{
    D x1, x2;
    std::cout << typeid(decltype(x1 <=> x2)).name() << std::endl;
    // St15strong_ordering
    return 0;
}
```

å¯¹ç»“æ„ä½“Bè€Œè¨€ï¼Œç”±äºintå’Œlongçš„æ¯”è¾ƒç»“æœéƒ½æ˜¯`std::strong_ordering`ï¼Œå› æ­¤ç»“æ„ä½“Bçš„ä¸‰å‘æ¯”è¾ƒç»“æœä¹Ÿæ˜¯`std::strong_ordering`ã€‚  
å¯¹ç»“æ„ä½“Dï¼Œå…¶ åŸºç±» å’Œ æˆå‘˜ çš„æ¯”è¾ƒç»“æœæ˜¯`std::strong_ordering`ï¼ŒDçš„ä¸‰å‘æ¯”è¾ƒç»“æœåŒæ ·æ˜¯`std::strong_ordering`ã€‚

### std::weak_ordering

```cpp
lhs <=> rhs
    - std::weak_ ordering::less      å¯¹åº” lhs < rhs
    - std::weak_ordering::equivalent å¯¹åº” lhs == rhs
    - std::weak_ ordering::greater   å¯¹åº” lhs > rhs
```

weakè¡¨è¾¾çš„æ˜¯ä¸å¯æ›¿æ¢æ€§ã€‚å³è‹¥æœ‰`lhs == rhs`ï¼Œåˆ™rhså’Œlhsä¸å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¹Ÿå°±æ˜¯`fx(lhs) != fx(rhs)`ã€‚è¿™ç§æƒ…å†µåœ¨åŸºç¡€ç±»å‹ä¸­å¹¶æ²¡æœ‰ï¼Œä½†æ˜¯å®ƒå¸¸å¸¸å‘ç”Ÿåœ¨ç”¨æˆ·è‡ªå®šä¹‰ç±»ä¸­ï¼Œæ¯”å¦‚ä¸€ä¸ªå¤§å°å†™ä¸æ•æ„Ÿçš„å­—ç¬¦ä¸²ç±»ï¼š

```cpp
#include <iostream>
#include <compare>
#include <string>

using namespace std;

int ci_compare(const char* s1, const char* s2)
{
    while(tolower(*s1) == tolower(*s2++))
    {
        if(*s1++ == '\0')
        {
            return 0;
        }
    }
    return tolower(*s1) - tolower(*--s2);
}

class CIString
{
public:
    CIString(const char*s) : str_(s){}
    std::weak_ordering operator<=>(const CIString& b) const
    {
        return ci_compare(str_.c_str(), b.str_.c_str()) <=> 0;
    }
private:
    std::string str_;
};

int main()
{
    CIString s1{"HELLO"}, s2{"hello"};
    std::cout << (s1 <=> s2 == 0) << std::endl;
    // 1
    return 0;
}
```

ä»¥ä¸Šä»£ç å®ç°äº†ä¸€ä¸ªç®€å•çš„å¤§å°å†™ä¸æ•æ„Ÿçš„å­—ç¬¦ä¸²ç±»ï¼Œå®ƒå¯¹äºs1å’Œs2çš„æ¯”è¾ƒç»“æœæ˜¯`std::weak_ordering::equivalent`ï¼Œè¡¨ç¤ºä¸¤ä¸ªæ“ä½œæ•°æ˜¯ç­‰ä»·çš„ã€‚ä½†æ˜¯å®ƒä»¬ä¸æ˜¯ç›¸ç­‰çš„ä¹Ÿä¸èƒ½ç›¸äº’æ›¿æ¢ã€‚å½“`std::weak_ordering`å’Œ`std::strong_ordering`åŒæ—¶å‡ºç°åœ¨åŸºç±»å’Œæ•°æ®æˆå‘˜çš„ç±»å‹ä¸­æ—¶ï¼Œè¯¥ç±»å‹çš„ä¸‰å‘æ¯”è¾ƒç»“æœæ˜¯`std::weak_ordering`ï¼Œä¾‹å¦‚ï¼š

```cpp
struct D : B 
{
  CIString c{""};
  auto operator <=> (const D&) const = default;
};

D w1, w2;
std::cout << typeid(decltype(w1 <=> w2)).name();
```

ç”¨MSVCç¼–è¯‘è¿è¡Œä¸Šé¢è¿™æ®µä»£ç ä¼šè¾“å‡º`class std::weak_ordering`ï¼Œå› ä¸ºDä¸­çš„æ•°æ®æˆå‘˜CIStringçš„ä¸‰å‘æ¯”è¾ƒç»“æœä¸º`std::weak_ordering`ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœæ˜¾å¼å£°æ˜é»˜è®¤ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°ä¸º`std::strong_ordering operator <=> (const D&) const = default;`é‚£ä¹ˆä¸€å®šä¼šé­é‡åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚

### std::partial_ordering

```cpp
std::partial_ordering
    - std::partial_ordering::less
    - std::partial_ordering::equivalent
    - std::partial_ ordering::greater
    - std::partial_ordering::unordered
```

`std::partial_ordering`çº¦æŸåŠ›æ¯”`std::weak_ordering`æ›´å¼±ï¼Œå®ƒå¯ä»¥æ¥å—å½“`lhs == rhs`æ—¶rhså’Œlhsä¸èƒ½ç›¸äº’æ›¿æ¢ã€‚
åŒæ—¶å®ƒè¿˜èƒ½ç»™å‡ºç¬¬å››ä¸ªç»“æœ`std::partial_ordering::unordered`ï¼Œè¡¨ç¤ºè¿›è¡Œæ¯”è¾ƒçš„ä¸¤ä¸ªæ“ä½œæ•°æ²¡æœ‰å…³ç³»ã€‚æ¯”å¦‚åŸºç¡€ç±»å‹ä¸­çš„æµ®ç‚¹æ•°ï¼š

```cpp
#include <iostream>
using namespace std;

int main()
{
    std::cout << typeid(decltype(7.7 <=> 11.1)).name();
    // St16partial_ordering
    return 0;
}
```

ä¼šè¾“å‡º`class std::partial_ordering`è€Œä¸æ˜¯`std::strong_ordering`ï¼Œæ˜¯å› ä¸ºæµ®ç‚¹çš„é›†åˆä¸­å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„NaNï¼Œå®ƒå’Œå…¶ä»–æµ®ç‚¹æ•°å€¼æ˜¯æ²¡å…³ç³»çš„ï¼š

```cpp
#include <iostream>
using namespace std;

int main()
{
    std::cout << ((0.0 / 0.0 <=> 1.0) == std::partial_ordering::unordered);
    // 1
    return 0;
}
```

å½“`std::weak_ordering`å’Œ`std::partial_ordering`åŒæ—¶å‡ºç°åœ¨åŸºç±»å’Œæ•°æ®æˆå‘˜çš„ç±»å‹ä¸­æ—¶ï¼Œè¯¥ç±»å‹çš„ä¸‰å‘æ¯”è¾ƒç»“æœæ˜¯`std::partial_ordering`ï¼Œä¾‹å¦‚ï¼š

```cpp
struct D : B 
{
  CIString c{""};
  float u;
  auto operator <=> (const D&) const = default;
};

D w1, w2;
std::cout << typeid(decltype(w1 <=> w2)).name();
// class std::partial_ordering
```

å†æ¬¡å¼ºè°ƒä¸€ä¸‹ï¼Œ`std::strong_ordering`ã€`std::weak_ordering`å’Œ`std::partial_ordering`åªèƒ½ä¸0å’Œç±»å‹è‡ªèº«æ¯”è¾ƒã€‚æ·±ç©¶å…¶åŸå› ï¼Œæ˜¯è¿™3ä¸ªç±»åªå®ç°äº†å‚æ•°ç±»å‹ä¸ºè‡ªèº«ç±»å‹å’Œ`nullptr_t`çš„æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°ã€‚

### std::variant

`std::variant`æ˜¯ C++17 å¼•å…¥çš„æ ‡å‡†åº“æ¨¡æ¿ï¼ˆä½¿ç”¨å‰è¯·ç¡®ä¿ä½ çš„ç¼–è¯‘å™¨æ”¯æŒ C++ 17ï¼‰ï¼Œå®ƒæä¾›äº†ä¸€ç§ç±»å‹å®‰å…¨çš„å˜ä½“ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨ä¸åŒç±»å‹çš„å€¼ã€‚ `std::variant`è¡¨ç¤ºä¸€ä¸ªç±»å‹å®‰å…¨çš„è”åˆä½“ï¼Œå³å¯ä»¥åœ¨ä¸€ä¸ªå˜é‡ä¸­å­˜å‚¨ä¸åŒç±»å‹çš„å€¼ï¼Œè€Œä¸”ä¸€æ¬¡åªèƒ½å­˜å‚¨å®ƒå…¶ä¸­ä¸€ä¸ªå¯èƒ½çš„ç±»å‹çš„å€¼ã€‚ `std::variant`çš„ä¸»è¦ä¼˜ç‚¹æ˜¯æä¾›äº†ç±»å‹å®‰å…¨å’Œçµæ´»æ€§ã€‚å®ƒå¯ä»¥ç”¨äºå¤„ç†å…·æœ‰å¤šç§å¯èƒ½ç±»å‹çš„æ•°æ®ï¼Œä¾‹å¦‚åœ¨å‡½æ•°å‚æ•°ä¸­ä¼ é€’ä¸åŒç±»å‹çš„å‚æ•°ï¼Œæˆ–è€…åœ¨å¤„ç†å¼‚è´¨é›†åˆæ—¶å­˜å‚¨ä¸åŒç±»å‹çš„å…ƒç´ ã€‚ ä»¥ä¸‹æ˜¯ä½¿ç”¨`std::variant`çš„ä¸€äº›ç¤ºä¾‹ä»£ç ï¼š

```cpp
#include <iostream>
#include <variant>
using namespace std;

void processVariant(const std::variant<int, double, std::string>& v)
{
    std::visit([](auto &value){
        std::cout << "Value: " << value << std::endl;
    }, v);
}

int main()
{
    std::variant<int, double, std::string> v = 42;
    processVariant(v);
    v = 3.14;
    processVariant(v);
    v = "Hello, world";
    processVariant(v);
    std::cout << typeid(std::get<0>(v)).name() << std::endl;
    // i
    std::cout << typeid(std::get<1>(v)).name() << std::endl;
    // d
    std::cout << typeid(std::get<2>(v)).name() << std::endl;
    // NSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE
    return 0;
}
/*
Value: 42
Value: 3.14
Value: Hello, world
*/
// https://en.cppreference.com/w/cpp/utility/variant
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`std::variant`åœ¨å­˜å‚¨ç±»å‹æ—¶ä½¿ç”¨äº†åŠ¨æ€å¤šæ€æ€§ï¼ˆå³è¿è¡Œæ—¶å¤šæ€ï¼‰ï¼Œè¿™æ„å‘³ç€åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šå­˜å‚¨çš„å…·ä½“ç±»å‹ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶æ ¹æ®å®é™…èµ‹å€¼æ¥ç¡®å®šã€‚ è¿™ä¹Ÿæ„å‘³ç€åœ¨ä½¿ç”¨`std::variant`æ—¶ï¼Œéœ€è¦è°¨æ…å¤„ç†ç±»å‹è½¬æ¢å’Œæ“ä½œï¼Œä»¥ç¡®ä¿ç±»å‹å®‰å…¨ã€‚

### std::common_comparison_category

åœ¨C++20çš„æ ‡å‡†åº“ä¸­æœ‰ä¸€ä¸ªæ¨¡æ¿å…ƒå‡½æ•° `std::common_comparison_category` ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ä¸€ä¸ªç±»å‹åˆé›†ä¸­åˆ¤æ–­å‡ºæœ€ç»ˆä¸‰å‘æ¯”è¾ƒçš„ç»“æœç±»å‹ï¼Œå½“ç±»å‹åˆé›†ä¸­å­˜åœ¨ä¸æ”¯æŒä¸‰å‘æ¯”è¾ƒçš„ç±»å‹æ—¶ï¼Œè¯¥æ¨¡æ¿å…ƒå‡½æ•°è¿”å›voidã€‚

```cpp
https://en.cppreference.com/w/cpp/utility/compare/common_comparison_category
```

### å¯¹åŸºç¡€ç±»å‹çš„æ”¯æŒ

1. å¯¹ä¸¤ä¸ªç®—æœ¯ç±»å‹çš„æ“ä½œæ•°è¿›è¡Œä¸€èˆ¬ç®—æœ¯è½¬æ¢ï¼Œç„¶åè¿›è¡Œæ¯”è¾ƒã€‚å…¶ä¸­æ•´å‹çš„æ¯”è¾ƒç»“æœä¸º`std::strong_ordering`ï¼Œæµ®ç‚¹å‹çš„æ¯”è¾ƒç»“æœä¸º`std::partial_ordering`ã€‚ä¾‹å¦‚`7 <=> 11.1`ä¸­ï¼Œæ•´å‹7ä¼šè½¬æ¢ä¸ºæµ®ç‚¹ç±»å‹ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒï¼Œæœ€ç»ˆç»“æœä¸º`std::partial_ordering`ç±»å‹ã€‚
2. å¯¹äºæ— ä½œç”¨åŸŸæšä¸¾ç±»å‹å’Œæ•´å‹æ“ä½œæ•°ï¼Œæšä¸¾ç±»å‹ä¼šè½¬æ¢ä¸ºæ•´å‹å†è¿›è¡Œæ¯”è¾ƒï¼Œæ— ä½œç”¨åŸŸæšä¸¾ç±»å‹æ— æ³•ä¸æµ®ç‚¹ç±»å‹æ¯”è¾ƒã€‚

```cpp
enum color {
  red
};

auto r = red <=> 11;   //ç¼–è¯‘æˆåŠŸ
auto r = red <=> 11.1; //ç¼–è¯‘å¤±è´¥
```

3. å¯¹ä¸¤ä¸ªç›¸åŒæšä¸¾ç±»å‹çš„æ“ä½œæ•°æ¯”è¾ƒç»“æœï¼Œå¦‚æœæšä¸¾ç±»å‹ä¸åŒï¼Œåˆ™æ— æ³•ç¼–è¯‘ã€‚
4. å¯¹äºå…¶ä¸­ä¸€ä¸ªæ“ä½œæ•°ä¸ºboolç±»å‹çš„æƒ…å†µï¼Œå¦ä¸€ä¸ªæ“ä½œæ•°å¿…é¡»ä¹Ÿæ˜¯boolç±»å‹ï¼Œå¦åˆ™æ— æ³•ç¼–è¯‘ã€‚æ¯”è¾ƒç»“æœä¸º`std::strong_ordering`ã€‚
5. ä¸æ”¯æŒä½œæ¯”è¾ƒçš„ä¸¤ä¸ªæ“ä½œæ•°ä¸ºæ•°ç»„çš„æƒ…å†µï¼Œä¼šå¯¼è‡´ç¼–è¯‘å‡ºé”™ï¼Œä¾‹å¦‚ï¼š

```cpp
int arr1[5];
int arr2[5];
auto r = arr1 <=> arr2; // ç¼–è¯‘å¤±è´¥
```

6. å¯¹äºå…¶ä¸­ä¸€ä¸ªæ“ä½œæ•°ä¸ºæŒ‡é’ˆç±»å‹çš„æƒ…å†µï¼Œéœ€è¦å¦ä¸€ä¸ªæ“ä½œæ•°æ˜¯åŒæ ·ç±»å‹çš„æŒ‡é’ˆï¼Œæˆ–è€…æ˜¯å¯ä»¥è½¬æ¢ä¸ºç›¸åŒç±»å‹çš„æŒ‡é’ˆï¼Œæ¯”å¦‚æ•°ç»„åˆ°æŒ‡é’ˆçš„è½¬æ¢ã€æ´¾ç”Ÿç±»æŒ‡é’ˆåˆ°åŸºç±»æŒ‡é’ˆçš„è½¬æ¢ç­‰ï¼Œæœ€ç»ˆæ¯”è¾ƒç»“æœä¸º`std::strong_ordering`ã€‚

```cpp
char arr1[5];
char arr2[5];
char* ptr = arr2;
auto r = ptr <=> arr1;
// ä¸Šé¢çš„ä»£ç å¯ä»¥ç¼–è¯‘æˆåŠŸï¼Œè‹¥å°†ä»£ç ä¸­çš„arr1æ”¹å†™ä¸ºint arr1[5]ï¼Œåˆ™æ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºint [5]æ— æ³•è½¬æ¢ä¸ºchar *ã€‚å¦‚æœå°†char * ptr = arr2;ä¿®æ”¹ä¸ºvoid * ptr = arr2;ï¼Œå°±å¯ä»¥ç¼–è¯‘æˆåŠŸäº†ã€‚
```

### è‡ªåŠ¨ç”Ÿæˆçš„æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°

æ ‡å‡†åº“ä¸­æä¾›äº†ä¸€ä¸ªåä¸º`std::rel_ops`çš„å‘½åç©ºé—´ï¼Œåœ¨ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹å·²ç»æä¾›äº†`==`è¿ç®—ç¬¦å‡½æ•°å’Œ<è¿ç®—ç¬¦å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œå¸®åŠ©ç”¨æˆ·å®ç°å…¶ä»–4ç§è¿ç®—ç¬¦å‡½æ•°ï¼Œ åŒ…æ‹¬`!=ã€>ã€<=å’Œ>=`ï¼Œä¾‹å¦‚ï¼š

```cpp
#include <string>
#include <utility>
class CIString2 {
public:
  CIString2(const char* s) : str_(s) {}

  bool operator < (const CIString2& b) const {
       return ci_compare(str_.c_str(), b.str_.c_str()) < 0;
  }
private:
  std::string str_;
};

using namespace std::rel_ops;
CIString2 s1{ "hello" }, s2{ "world" };
bool r = s1 >= s2;
```

ä¸è¿‡å› ä¸ºC++20æ ‡å‡†æœ‰äº†ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦çš„å…³ç³»ï¼Œæ‰€ä»¥ä¸æ¨èä¸Šé¢è¿™ç§åšæ³•äº†ã€‚C++20æ ‡å‡†è§„å®šï¼Œå¦‚æœç”¨æˆ·ä¸ºè‡ªå®šä¹‰ç±»å‹å£°æ˜äº†ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šä¸ºå…¶è‡ªåŠ¨ç”Ÿæˆ`<ã€>ã€<=å’Œ>=`è¿™4ç§è¿ç®—ç¬¦å‡½æ•°ã€‚å¯¹äºCIStringæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™4ç§è¿ç®—ç¬¦å‡½æ•°:

```cpp
CIString s1{ "hello" }, s2{ "world" };
bool r = s1 >= s2;
```

é‚£ä¹ˆè¿™é‡Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼Œå¾ˆæ˜æ˜¾ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦èƒ½è¡¨è¾¾ä¸¤ä¸ªæ“ä½œæ•°æ˜¯ç›¸ç­‰æˆ–è€…ç­‰ä»·çš„å«ä¹‰ï¼Œä¸ºä»€ä¹ˆæ ‡å‡†åªå…è®¸è‡ªåŠ¨ç”Ÿæˆ4ç§è¿ç®—ç¬¦å‡½æ•°ï¼Œå´ä¸èƒ½è‡ªåŠ¨ç”Ÿæˆ`==å’Œ=!`è¿™ä¸¤ä¸ªè¿ç®—ç¬¦å‡½æ•°å‘¢ï¼Ÿå®é™…ä¸Šè¿™é‡Œå­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚åœ¨C++20æ ‡å‡†æ‹Ÿå®šä¸‰å‘æ¯”è¾ƒçš„æ—©æœŸï¼Œæ˜¯å…è®¸é€šè¿‡ä¸‰å‘æ¯”è¾ƒè‡ªåŠ¨ç”Ÿæˆ6ä¸ªæ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°çš„ï¼Œè€Œä¸‰å‘æ¯”è¾ƒçš„ç»“æœç±»å‹ä¹Ÿä¸æ˜¯3ç§è€Œæ˜¯5ç§ï¼Œå¤šå‡ºæ¥çš„ä¸¤ç§åˆ†åˆ«æ˜¯`std::strong_equality`å’Œ`std::weak_equality`ã€‚ä½†æ˜¯åœ¨ææ¡ˆæ–‡æ¡£p1190ä¸­æå‡ºäº†ä¸€ä¸ªä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚ç®€å•æ¥è¯´ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç»“æ„ä½“ï¼š

```cpp
struct S {
    std::vector<std::string> names;
    auto operator<=>(const S &) const = default;
};
```

å®ƒçš„ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦çš„é»˜è®¤å®ç°è¿™æ ·çš„ï¼š

```cpp
template<typename T>
std::strong_ordering operator<=>(const std::vector<T>& lhs, const std::vector<T> & rhs)
{
    size_t min_size = min(lhs.size(), rhs.size());
    for (size_t i = 0; i != min_size; ++i) {
        if (auto const cmp = std::compare_3way(lhs[i], rhs[i]); cmp != 0) {
            return cmp;
        }
    }
    return lhs.size() <=> rhs.size();
}
```

è¿™ä¸ªå®ç°å¯¹äº`<å’Œ>`è¿™æ ·çš„è¿ç®—ç¬¦å‡½æ•°æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºéœ€è¦æ¯”è¾ƒå®¹å™¨ä¸­çš„æ¯ä¸ªå…ƒç´ ã€‚ä½†æ˜¯`==`è¿ç®—ç¬¦å°±æ˜¾å¾—ååˆ†ä½æ•ˆï¼Œå¯¹äº`==`è¿ç®—ç¬¦é«˜æ•ˆçš„åšæ³•æ˜¯å…ˆæ¯”è¾ƒå®¹å™¨ä¸­çš„å…ƒç´ æ•°é‡æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœå…ƒç´ æ•°é‡ä¸åŒï¼Œåˆ™ç›´æ¥è¿”å›falseï¼š

```cpp
template<typename T>
bool operator==(const std::vector<T>& lhs, const std::vector<T>& rhs)
{
    const size_t size = lhs.size();
    if (size != rhs.size()) {
        return false;
    }

    for (size_t i = 0; i != size; ++i) {
        if (lhs[i] != rhs[i]) {
            return false;
        }
    }
    return true;
}
```

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ ‡å‡†å…è®¸ç”¨ä¸‰å‘æ¯”è¾ƒçš„ç®—æ³•è‡ªåŠ¨ç”Ÿæˆ`==`è¿ç®—ç¬¦å‡½æ•°ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Œ å¾ˆå¤šæ—§ä»£ç å‡çº§ç¼–è¯‘ç¯å¢ƒåä¼šå‘ç°è¿è¡Œæ•ˆç‡ä¸‹é™äº†ï¼Œå°¤å…¶æ˜¯åœ¨å®¹å™¨ä¸­å…ƒç´ æ•°é‡ä¼—å¤šä¸”æ¯ä¸ªå…ƒç´ æ•°æ®é‡åºå¤§çš„æƒ…å†µä¸‹ã€‚ å¾ˆå°‘æœ‰ç¨‹åºå‘˜ä¼šæ³¨æ„åˆ°ä¸‰å‘æ¯”è¾ƒç®—æ³•çš„ç»†èŠ‚ï¼Œå¯¼è‡´è¿™ä¸ªæ€§èƒ½é—®é¢˜éš¾ä»¥æ’æŸ¥ã€‚åŸºäºè¿™ç§è€ƒè™‘ï¼ŒC++å§”å‘˜ä¼šä¿®æ”¹äº†åŸæ¥çš„ä¸‰å‘æ¯”è¾ƒææ¡ˆï¼Œ è§„å®šå£°æ˜ä¸‰å‘æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°åªèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆ4ç§æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°ã€‚ç”±äºä¸éœ€è¦è´Ÿè´£åˆ¤æ–­æ˜¯å¦ç›¸ç­‰ï¼Œ å› æ­¤`std::strong_equality`å’Œ`std::weak_equality`ä¹Ÿé€€å‡ºäº†å†å²èˆå°ã€‚å¯¹äº`==å’Œ!=`ä¸¤ç§æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°ï¼Œ åªéœ€è¦å¤šå£°æ˜ä¸€ä¸ª`==`è¿ç®—ç¬¦å‡½æ•°ï¼Œ`!=`è¿ç®—ç¬¦å‡½æ•°ä¼šæ ¹æ®å‰è€…è‡ªåŠ¨ç”Ÿæˆï¼š

```cpp
class CIString {
public:
  CIString(const char* s) : str_(s) {}

  std::weak_ordering operator<=>(const CIString& b) const {
       return ci_compare(str_.c_str(), b.str_.c_str()) <=> 0;
  }

  bool operator == (const CIString& b) const {
       return ci_compare(str_.c_str(), b.str_.c_str()) == 0;
  }
private:

  std::string str_;
};

CIString s1{ "hello" }, s2{ "world" };
bool r1 = s1 >= s2; // è°ƒç”¨operator<=>
bool r2 = s1 == s2; // è°ƒç”¨operator ==
```

### å…¼å®¹æ—§ä»£ç 

ç°åœ¨C++20æ ‡å‡†å·²ç»æ¨èä½¿ç”¨`<=>å’Œ==`è¿ç®—ç¬¦è‡ªåŠ¨ç”Ÿæˆå…¶ä»–æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°ï¼Œè€Œä½¿ç”¨`<ã€==ä»¥åŠstd::rel_ops`ç”Ÿæˆå…¶ä»–æ¯”è¾ƒè¿ç®—ç¬¦å‡½æ•°ä¼šå› ä¸º`std::rel_ops`å·²ç»ä¸è¢«æ¨èä½¿ç”¨è€Œè¢«ç¼–è¯‘å™¨è­¦å‘Šã€‚åˆ™é‚£ä¹ˆå¯¹äºè€ä»£ç ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦å»å®ç°ä¸€å¥—`<=>å’Œ==`è¿ç®—ç¬¦å‡½æ•°å‘¢ï¼Ÿå…¶å®å¤§å¯ä¸å¿…ï¼ŒC++å§”å‘˜ä¼šåœ¨è£å†³è¿™é¡¹ä¿®æ”¹çš„æ—¶å€™å·²ç»è€ƒè™‘åˆ°è€ä»£ç çš„ç»´æŠ¤æˆæœ¬ï¼Œæ‰€ä»¥åšäº†å…¼å®¹æ€§å¤„ç†ï¼Œå³åœ¨ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹ä¸­ï¼Œå®ç°äº†`<ã€==`è¿ç®—ç¬¦å‡½æ•°çš„æ•°æ®æˆå‘˜ç±»å‹ï¼Œåœ¨è¯¥ç±»å‹çš„ä¸‰å‘æ¯”è¾ƒä¸­å°†è‡ªåŠ¨ç”Ÿæˆåˆé€‚çš„æ¯”è¾ƒä»£ç ã€‚æ¯”å¦‚ï¼š

```cpp
struct Legacy {
  int n;
  bool operator==(const Legacy& rhs) const
  {
       return n == rhs.n;
  }
  bool operator<(const Legacy& rhs) const
  {
       return n < rhs.n;
  }
};

struct TreeWay {
  Legacy m;
  std::strong_ordering operator<=>(const TreeWay &) const = default;
};

TreeWay t1, t2;
bool r = t1 < t2;
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç»“æ„ä½“TreeWayçš„ä¸‰å‘æ¯”è¾ƒæ“ä½œä¼šè°ƒç”¨ç»“æ„ä½“Legacyä¸­çš„`<å’Œ==`è¿ç®—ç¬¦æ¥å®Œæˆï¼Œå…¶ä»£ç ç±»ä¼¼äºï¼š

```cpp
struct TreeWay {
  Legacy m;
  std::strong_ordering operator<=>(const TreeWay& rhs) const {
       if (m < rhs.m) return std::strong_ordering::less;
       if (m == rhs.m) return std::strong_ordering::equal;
       return std::strong_ordering::greater;
  }
};
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œ`operator<=>`å¿…é¡»æ˜¾å¼å£°æ˜è¿”å›ç±»å‹ä¸º`std::strong_ordering`ï¼Œä½¿ç”¨autoæ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„ã€‚

### ä¸‰å‘æ¯”è¾ƒæ€»ç»“

C++20æ–°å¢çš„ä¸‰å‘æ¯”è¾ƒç‰¹æ€§ï¼Œè¯¥ç‰¹æ€§çš„å¼•å…¥ä¸ºå®ç°æ¯”è¾ƒè¿ç®—æä¾›äº†æ–¹ä¾¿ã€‚ æˆ‘ä»¬åªéœ€è¦å®ç°`==å’Œ<=>`ä¸¤ä¸ªè¿ç®—ç¬¦å‡½æ•°ï¼Œå‰©ä¸‹çš„4ä¸ªè¿ç®—ç¬¦å‡½æ•°å°±å¯ä»¥äº¤ç»™ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆäº†ã€‚ è™½è¯´`std::rel_ops`åœ¨å®ç°äº†`==å’Œ<`ä¸¤ä¸ªè¿ç®—ç¬¦å‡½æ•°ä»¥åä¹Ÿèƒ½è‡ªåŠ¨æä¾›å‰©ä¸‹çš„4ä¸ªè¿ç®—ç¬¦å‡½æ•°ï¼Œ ä½†æ˜¾ç„¶ç”¨ä¸‰å‘æ¯”è¾ƒæ›´åŠ ä¾¿æ·ã€‚å¦å¤–ï¼Œä¸‰å‘æ¯”è¾ƒæä¾›çš„3ç§ç»“æœç±»å‹ä¹Ÿæ˜¯`std::rel_ops`æ— æ³•åª²ç¾çš„ã€‚ è¿›ä¸€æ­¥æ¥è¯´ï¼Œç”±äºä¸‰å‘æ¯”è¾ƒçš„å‡ºç°ï¼Œ`std::rel_ops`åœ¨C++20ä¸­å·²ç»ä¸è¢«æ¨èä½¿ç”¨äº†ã€‚ æœ€åï¼ŒC++å§”å‘˜ä¼šæ²¡æœ‰å¿˜è®°å…¼å®¹æ€§é—®é¢˜ï¼Œè¿™è®©ä¸‰å‘æ¯”è¾ƒèƒ½å¤Ÿé€šè¿‡è¿ç®—ç¬¦å‡½æ•°`<å’Œ==`æ¥è‡ªåŠ¨ç”Ÿæˆã€‚
