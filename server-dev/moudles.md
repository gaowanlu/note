# 服务器开发中的常用模块

## 断线自动重连的应用场景和逻辑设计

* 对于服务端
    
    重连逻辑一般很简单，A一旦发现与B断开连接，就立即尝试与B重新连接，如果连接不上，则隔一段时间重试，再此期间可以发送警报邮件或输出错误日志

* 对于客户端

    一般会一个比前一个间隔时间更长的时间间隔去重连，此外还可以监听网络状态，如果网络状态发生波动，程序就应该检测网络状态，如果网络状态恢复正常，就应该立即进行一次重连

1、不需要重连的场景

（1）用户使用客户端主动放弃重连（2）因为一些业务上的要求，禁止客户端连接

2、技术上的断线重连和业务上的断线重连

技术上的断线重连为套接字的connect，业务上的重连指的还有如用户身份验证等业务流程包括在内

## 保活机制与心跳包

情景一：A与B端之间，有必经的路由器或交换机故障，无法正常通信，那么一段时间二者之间没有信息交换，由于TCP连接是状态机，这种情况两端都无法感知与对方的连接是否正常，称为“死链”，只要此时在任意一端向对端发送一个数据包，即可检测链路是否正常，这类数据包称为“心跳包”，这种操作称为“心跳检测”

情景二：客户端在连接服务器后，如果长时间没有数据往来，可能会被防火墙程序关闭连接。有时我们业务必须要求连接正常，这种需求称为“保活”

心跳检测的两个作用：保活和检测死链

### Tcp keepalive选项

操作系统的TCP/IP协议栈提供了keepalive选项用于socket的保活,发送心跳检测包的时间间隔默认为7200秒（两个小时）

```cpp
int on=1;
setsockopt(fd,SOL_SOCKET,SO_KEEPALIVE,&on,sizeof(on));
```

修改发送检测包的时间间隔

```cpp
int val=7200;
setsockopt(fd,IPPROTO_TCP,TCP_KEEPIDLE,&val,sizeof(val));
```

如果发送检测包，对方没回应，在进行重发的间隔时间

```cpp
int interval=75;//seconds
setsockopt(fd,IPPROTO_TCP,TCP_KEEPINTVL,&interval,sizeof(interval));
```

没回应最多重发间隔次数

```cpp
int cnt=9;
setsockopt(fd,IPPROTO_TCP,TCP_KEEPCNT,&cnt,sizeof(cnt));
```

TCP_KEEPIDLE设置发送keepalive报文的时间间隔，如果对端恢复ACK，则本端TCP认为连接依然存活，等TCP_KEEPIDLE秒后发送下一个keepalive包，如果对端回复RESET，则说明对端进程已重启，本段应用层与应该关闭此连接

如果对端没有任何回复，则进行重传，重传时间间隔为TCP_KEEPINTVL，若连续尝试TCP_KEEPCNT此仍不可达，则向程序返回ETIMEOUT（无任何应答）或EHOST错误信息

```shell
gaowanlu@DESKTOP-QDLGRDB:/$ sysctl -a | grep keepalive
net.ipv4.tcp_keepalive_intvl = 75
net.ipv4.tcp_keepalive_probes = 9
net.ipv4.tcp_keepalive_time = 7200
```

### 应用层的心跳包机制设计

在使用keepalive时，需要对每个连接中的socket进行设置，而不一定是必须的可能会产生毫无意义的贷款浪费，而且也不能和应用层很好地交互

应用层可以设计，在每个连接的收发数据的最新时间，当send和recv时进行更新，通知设置一个最大间隔时间，在Loop时进行检查如果超过了心跳间隔时间则发送一次心跳包

另一端的话同理，在send、recv时更新时间，设置一个超时时间，如果间隔多长时间还没有收发数据则关闭连接

### 有代理的心跳包机制设计

有的系统架构中间有代理服务器,有时客户端与代理服务器已经断开了，而后端服务器与代理服务器还在连接，这种心跳检测，可以检测客户端的上行数据时间，让客户端发送检测包

```cpp
            后端服务器
                |
            代理服务器
        ————————|————————
        |       |        |
       client1 client2   client3
```

### 带业务数据的心跳包

应用层设计心跳包可以设计为携带某些业务数据，在心跳包数据结构中加上需要的业务字段信息，然后在定时器中定时发送即可

### 心跳包与流量

心跳包的数据结构尽可能设计为小空间，为服务端与用户客户端节省流量带宽

### 心跳包与调试

在开发调试中可能不需要进行心跳包的调试，可以为其设置开关

## 心跳包与日志

在实际生产环境中，一般将程序收到的和发出去的数据报写到日志中，但是心跳包是特例，记录它毫无意义

## 日志模块的设计

### 为什么需要日志

### 日志系统的技术实现

### 在C/C++中输出网络数据包日志

### 调试时的日志

### 统计程序性能日志

### 根据类型将日志写入不同的文件中

### 集中式日志服务和分布式日志服务

### 从业务层面看在一条日志中应该包含什么内容

### 在日志中不要出现敏感信息

### 开发过程中的日志递进缩减策略

## 错误码系统的设计

### 错误码的作用

### 错误码系统设计与实践

## 监控端口
