---
coverY: 0
---

# 第 17 章 高级进程间通信

## 高级进程间通信

## UNINX 域套接字

前面讨论了 UNIX 系统各种 IPC、管道、共享内存、套接字、消息队列，本章将会学习一种高级 IPC，UNIX 域套接字机制。

UNIX 域套接字是一种用于在同一台计算机上的进程之间进行通信的机制。它类似于网络套接字，但不依赖于网络协议栈，而是在操作系统的内核中直接传递数据。

UNIX 域套接字使用文件系统路径作为套接字地址，进程可以通过打开和读写文件来进行通信。这种通信方式比使用网络套接字更高效，因为数据不需要通过网络协议栈进行封装和解封装。

UNIX 域套接字通常用于同一台计算机上的进程间通信，例如在客户端和服务器之间进行本地通信。它提供了一种可靠的、高性能的通信机制，适用于需要高速数据传输和低延迟的应用程序。

### socketpair 函数

socketpair 函数是用于创建一对相互连接的 UNIX 域套接字的函数。它的原型如下：

```cpp
#include <sys/types.h>
#include <sys/socket.h>
int socketpair(int domain, int type, int protocol, int sv[2]);
```

- domain ：指定套接字的域，通常为 AF_UNIX 表示 UNIX 域套接字。
- type ：指定套接字的类型，可以是 SOCK_STREAM 表示面向连接的流套接字，或者 SOCK_DGRAM 表示面向消息的数据报套接字。
- protocol ：指定套接字的协议，通常为 0，表示使用默认的协议。
- sv ：一个长度为 2 的整数数组，用于存储创建的套接字描述符。

使用注意事项：

- socketpair 函数创建的套接字对是全双工的，可以在两个进程之间进行双向通信。
- UNIX 域套接字是在本地计算机上的进程间通信，不涉及网络传输，因此速度较快。
- 创建的套接字对会自动关联到当前进程的文件描述符表中。

socketpair 为什么会返回两个 socket 文件描述符?

socketpair 函数返回两个套接字文件描述符，一个用于读取数据，一个用于写入数据。这是因为 socketpair 函数创建的是一对相互连接的套接字，可以实现双向通信。  
其中， sv[0] 代表读取数据的套接字文件描述符， sv[1] 代表写入数据的套接字文件描述符。通过这两个文件描述符，可以在两个进程之间进行双向通信，实现数据的发送和接收。  
需要注意的是，socketpair 函数创建的套接字对是全双工的，即可以同时进行读取和写入操作。因此，通过这两个套接字文件描述符，可以实现双向的数据传输。

从第 1 个 fd 写的数据从第 2 个 fd 读出  
从第 2 个 fd 写的数据从第 1 个 fd 读出

```cpp
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <string.h>
 int main() {
    int sv[2];
    char buf[256];
     if (socketpair(AF_UNIX, SOCK_STREAM, 0, sv) == -1) {
        perror("socketpair");
        return 1;
    }
     if (fork() == 0) {
        // 子进程
        close(sv[0]); // 关闭子进程中不需要的套接字端口
         // 子进程向父进程发送消息
        char childMsg[] = "Hello from child";
        write(sv[1], childMsg, strlen(childMsg) + 1);
         // 子进程从父进程接收消息
        read(sv[1], buf, sizeof(buf));
        printf("Child received message: %s\n", buf);
         close(sv[1]);
    } else {
        // 父进程
        close(sv[1]); // 关闭父进程中不需要的套接字端口
         // 父进程从子进程接收消息
        read(sv[0], buf, sizeof(buf));
        printf("Parent received message: %s\n", buf);
         // 父进程向子进程发送消息
        char parentMsg[] = "Hello from parent";
        write(sv[0], parentMsg, strlen(parentMsg) + 1);
         close(sv[0]);
    }
     return 0;
}
```

P17.2

## 命名 UNIX 域套接字

## 唯一连接

## 传送文件描述符

## 打开服务器进程
