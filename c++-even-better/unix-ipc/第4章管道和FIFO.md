---
coverY: 0
---

# 第4章 管道和FIFO

## 管道和FIFO

### 未完待续

1、概述：管道是UNIX IPC最初形式，只能在有亲缘的进程间使用，但在FIFO又称有名管道支持后改正，管道和FIFO通常使用read和write函数访问  
2、介绍了一个client发送路径名，服务端相应文件内容的一个例子  
3、管道：有pipe函数创建、返回两个文件描述符，前者读，后者写  
4、宏S_ISFIFO用来判断是管道还是FIFO  
5、管道是由内核管控的，用户进程需要与内核进行数据交换发送等等  
6、介绍了父进程子进程间用管道的案例，如单向通信等，并且介绍了管道在unix shell中的应用及其原理  
7、管道一般都是半双工使用，双向通信则建立两个管道  
8、介绍的父子进程间的两个管道的创建代码  
9、书中还介绍了子进程结束时，变为僵尸进程，内核会向父进程产生一个SIGCHLD信号，此信号默认是忽略的，介绍了父进程使用waitpid和父进程内有处理直接结束，子进程交给init进程管理，内核向init进程发送SIGCHLD信号，init进程获得僵尸进程的终止状态  
10、全双工管道：一个管道有一个缓冲区，读数据将从缓冲区的开头读取，写将写到缓冲区的末尾，全双工管道有两个缓冲区，本质上pipe返回两个文件标识符，其实是两个半双工的管道，原则上我们一个用来写，一个用来读，向fd[0]写fd[1]能读取到，向fd[1]写fd[0]能读取到  
11、popen函数与pclose函数：用于控制进程间的标准输入与标准输出，使其联系起来，有代码样例  
12、FIFO弥补了管道只能在有亲缘的进程间通信的缺点，FIFO先进先出(first in,first out)，FIFO是单向数据流，也成为有名管道  
13、FIFO由mkfifo函数创建，提供pathname与mode_t创建方式与之前的mode_t有点类似，FIFO是半双工的，创建FIFO后可以使用open相关操作打开写或者读，不能又读又写，write总是添加数据到末尾，read总是读取头部的内容，不能使用lseek否则返回ESPIPE错误  
14、提供了使用FIFO建造进程全双工通信的案例，建造的FIFO需要使用unlink进行从文件系统中删除，需要注意的是一些，读写打开的细节问题  
15、FIFO打开可能产生死锁：最重要的是这里解释了死锁的问题，当前上没有任何进程打开FIFO写，那么想打开FIFO读的进程将会阻塞  
16、管道和FIFO的额外属性，介绍了使用fcntl为管道设置非阻塞，表格和详细介绍了阻塞和非阻塞对打开读写和读写的影响  
17、介绍了非阻塞，对FIFO open的影响，以及对管道和FIFO read和write的影响  
18、管道和FIFO的读写规则，读取量大于当管道和FIFO中可用数据量则有多少返回多少，但是写则有些不同，PIPE_BUF为Posix限制值，当数据量小于PIPE_BUF时则能保证写入时中间不被其他进程也写入数据，也就是原子性的，但是大于PIPE_BUF时则不能保证原子性，非阻塞下的读写与PIPE_BUF息息相关  
19、介绍了一个服务器，多个用户使用FIFO通信的实践样例，有两个client与一个server  
20、FIFO write原子性与PIPE_BUF关系  
21、FIFO只是在单台主机上的IPC，虽然使用了文件系统，但只能是本机的文件系统，如NFS(Network File System)是不行的  
22、介绍了迭代服务器与并发服务器，三种技巧，创建一个子进程池，让池中某个空闲子进程为一个新的客户服务，为每个客户创建新线程，创建线程池替换进程池  
23、拒接服务型攻击(DOS),有一个问题，在一个FIFO没有被别的进程打开读时，打开FIFO写会被阻塞，如果有一个服务，客户端发送自己创建的FIFO名字和相关信息，服务端解析后打开客户端指定的FIFO进行写响应内容，这样出现的问题是，此时可能客户端故意不打开FIFO的读，这样会导致服务端阻塞  
24、字节流与消息：带内特殊终止序列如每条消息末尾加\n(FTP,SMTP,HTTP,NNTP加\r\n),显式长度，开头有字段标志此次消息的长度，每次连接表示一个记录如HTTP1.0  
25、标准库I/O库函数可以读写一个管道或FIFO，也可以使其与某个已经打开的描述符进行相关联使用fdopen  
26、书中详细教学了，自定义struct协议包，一定要好好学一下，服务器大多数都是采用这种方式包括一些下位机通信等等  
27、管道和FIFO的系统限制，主要有OPEN_MAX和PIPE_BUF,OPEN_MAX为一个进程在任意时刻打开的最大描述符数(POSIX最低要求为16)，PIPE_BUF 可原子性地往一个管道或FIFO的最大数据量  
28、PIPE_BUF在`<limits.h>`头文件中定义，对于FIFO而言可能随着文件系统的差异会有不同，因为FIFO有名字，而管道没有名字  
29、PIPE_BUF可以通过调用pathconfig和fpathconfig获得，也可以shell中使用pipeconfig，ulimit，getconfig等使用，不同系统间也会有差异  
