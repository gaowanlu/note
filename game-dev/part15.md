---
cover: >-
  https://images.unsplash.com/photo-1650170496638-b05030a94005?crop=entropy&cs=srgb&fm=jpg&ixid=MnwxOTcwMjR8MHwxfHJhbmRvbXx8fHx8fHx8fDE2NTI1MzAzMzQ&ixlib=rb-1.2.1&q=85
coverY: 0
---

# 🚗 球球大作战

## 球球大作战

本部分用一个完整游戏案例《球球大作战》，介绍分布式游戏服务端的实现方法。

### 功能需求

《球球大作战》是一款多人对战游戏，玩家控制一个小球，让它在场景中移动，场景会随机产生食物，小球吃掉（碰到）食物后，体积会增大。
数十名玩家在同一场景堆栈，体积大的玩家可以吃掉体积小的玩家。

整个游戏流程如下：

1. 玩家输入账号密码登录游戏
2. 进入主界面，可以设置本轮游戏的昵称、选择服务器
3. 当玩家点击界面中的“开始比赛”按钮时，会进入某一战斗场景，在这里可以与其他玩家对战

假设预估有数万到数十万玩家同时在线，服务端也要根据这个量级来设计。

### 方案设计

因为要支持数以万计的在线玩家，必然要采取分布式的设计方案。

### 拓扑结构

服务端拓扑结构设计如下

![服务端拓扑结构设计](../.gitbook/assets/2023-10-22232405.png)

其中的圆圈代表服务，圈内文字表明服务的类型和编号。每个节点被划分为两部分，其中用虚线框起来的为`本地服务`,方框外的称为`全局服务`

| 类型     | 说明                                                                                                          |
| -------- | ------------------------------------------------------------------------------------------------------------- |
| 本地服务 | 在单节点内是唯一的，但是它不具备全局唯一性的服务                                                              |
| 全局服务 | 在所有节点中都具有唯一性的服务，如图中的 agentmgr,可以把它部署到节点 1 或者节点 2，但是在整个架构中只能有一个 |

### 各服务功能

服务端包含了 gateway、login 等多个类型的服务

- gateway

网关，用于处理客户端连接的服务，客户端会连接某个网关，如果玩家尚未登录，网关会把消息转发给节点内某个登录服务器，
以处理账号校验等操作；如果登录成功，则会把消息转发给客户端对应的代理(agent),一个节点可以开启多个网关以分摊性能

- login

登录服务，用于处理登录逻辑的服务，账号校验，一个节点可以开启多个登录服务分摊性能。

- agent

代理，每个客户端会对应一个代理服务(agent),负责对应角色的数据加载，数据存储，单服逻辑处理（如强化装备、成就等）。
处于性能考虑，agent 必须与它对应的客户端连接（即客户端连接的 gateway）处于在同一个节点。

- agentmgr

管理代理(agent)的服务，它会记录每个 agent 所在的节点，避免不同的客户端登录同一个账号

- nodemgr

节点管理，每个节点会开启一个 nodemgr 服务，用于管理该节点和监控性能

- scene

场景服务，处理战斗逻辑的服务，每一局游戏由一个场景服务负责。

### 消息流程

从客户端发起连接开始，服务端内部的消息处理流程如下，简化忽略了 nodemgr

![服务端消息处理流程](../.gitbook/assets/2023-10-22234252.png)

- 登录过程

在第 1 阶段，客户端连接某个 gateway，然后发送登录协议，gateway 将登录协议转发给 login（阶段 2），校验账号后，
由 agentmgr 创建与客户端对应的 agent（阶段 3 和 4）完成登录。如果玩家已经在其他节点登录，agentmgr 会把另一个客户端下线处理。

- 游戏过程

登录成功后，客户端的消息经由 gateway 转发给对应的 agent（阶段 5），agent 会处理角色的个人功能，比如购买装备、查看成就等。
当客户端发送开始比赛的协议时，程序会选择一个场景服务器，让它和 agent 关联，处理一场战斗（阶段 6）。

### 设计要点

- gateway

gateway 只做消息转发，解包，启用 gateway 服务是有好处的，隔离客户端与服务端系统，例如要更改客户端协议（如 json 改为 protobuf）
仅需要修改 gateway，不会对系统内部产生影响。

预留断线重连功能，如果客户端掉线，仅影响到 gateway，引入 gateway 意味着客户端消息需经过一层转发，会带来一定的延迟。将同一个客户端连接
的 gateway、login、agent 置于同一个节点有助于减少延迟。

- agent 与 scene 的关系

agent 可以和任意一个 scene 通信，但跨节点通信开销比较大，一个节点可以支撑数千名玩家，足以支撑各种段位的匹配，玩家应尽可能
进入同节点的战斗场景服务器（scene）。

- agentmgr

agentmgr 仅记录 agent 的状态、处理玩家登录，登出功能，所有对它的访问都以玩家 id 为索引，agentmgr 是一个单节点，但也很容易扩展为分布式。

### 分布式登录流程

处理玩家的登录，是服务端框架的主要功能之一，分布式系统涉及多个服务，让它们相互配置不产生重复是一大难点。

### 完整的登录流程

看一下下面的图大致就可以理解整体流程，这涉及到重复登录的场景

![登录架构流程](../.gitbook/assets/2023-10-23001534.png)

### 掉线登出流程

当客户端掉线时，登出流程如图所示

![掉线登出流程图](../.gitbook/assets/2023-10-23001706.png)

所有上线下线的请求都要经过 agentmgr，由它裁决，只有“已在线”状态的客户端方可被顶替下线，如果处于“登录中”或“登出中”，agentmgr 会告诉新登录的客户端“其他玩家正在尝试登录该账号，请稍后再试”。这样设计可以免去考虑很多复杂情况。

### 实现 gateway

### 实现 login

### 实现 agentmgr

### 实现 nodemgr

### 实现 agent 单机

### 测试登录流程

### 战斗流程

### 场景服务

### 实现 agent 跨服务器
