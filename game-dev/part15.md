---
cover: >-
  https://images.unsplash.com/photo-1650170496638-b05030a94005?crop=entropy&cs=srgb&fm=jpg&ixid=MnwxOTcwMjR8MHwxfHJhbmRvbXx8fHx8fHx8fDE2NTI1MzAzMzQ&ixlib=rb-1.2.1&q=85
coverY: 0
---

# ğŸš— çƒçƒå¤§ä½œæˆ˜

## çƒçƒå¤§ä½œæˆ˜

æœ¬éƒ¨åˆ†ç”¨ä¸€ä¸ªå®Œæ•´æ¸¸æˆæ¡ˆä¾‹ã€Šçƒçƒå¤§ä½œæˆ˜ã€‹ï¼Œä»‹ç»åˆ†å¸ƒå¼æ¸¸æˆæœåŠ¡ç«¯çš„å®ç°æ–¹æ³•ã€‚

### åŠŸèƒ½éœ€æ±‚

ã€Šçƒçƒå¤§ä½œæˆ˜ã€‹æ˜¯ä¸€æ¬¾å¤šäººå¯¹æˆ˜æ¸¸æˆï¼Œç©å®¶æ§åˆ¶ä¸€ä¸ªå°çƒï¼Œè®©å®ƒåœ¨åœºæ™¯ä¸­ç§»åŠ¨ï¼Œåœºæ™¯ä¼šéšæœºäº§ç”Ÿé£Ÿç‰©ï¼Œå°çƒåƒæ‰ï¼ˆç¢°åˆ°ï¼‰é£Ÿç‰©åï¼Œä½“ç§¯ä¼šå¢å¤§ã€‚
æ•°ååç©å®¶åœ¨åŒä¸€åœºæ™¯å †æ ˆï¼Œä½“ç§¯å¤§çš„ç©å®¶å¯ä»¥åƒæ‰ä½“ç§¯å°çš„ç©å®¶ã€‚

æ•´ä¸ªæ¸¸æˆæµç¨‹å¦‚ä¸‹ï¼š

1. ç©å®¶è¾“å…¥è´¦å·å¯†ç ç™»å½•æ¸¸æˆ
2. è¿›å…¥ä¸»ç•Œé¢ï¼Œå¯ä»¥è®¾ç½®æœ¬è½®æ¸¸æˆçš„æ˜µç§°ã€é€‰æ‹©æœåŠ¡å™¨
3. å½“ç©å®¶ç‚¹å‡»ç•Œé¢ä¸­çš„â€œå¼€å§‹æ¯”èµ›â€æŒ‰é’®æ—¶ï¼Œä¼šè¿›å…¥æŸä¸€æˆ˜æ–—åœºæ™¯ï¼Œåœ¨è¿™é‡Œå¯ä»¥ä¸å…¶ä»–ç©å®¶å¯¹æˆ˜

å‡è®¾é¢„ä¼°æœ‰æ•°ä¸‡åˆ°æ•°åä¸‡ç©å®¶åŒæ—¶åœ¨çº¿ï¼ŒæœåŠ¡ç«¯ä¹Ÿè¦æ ¹æ®è¿™ä¸ªé‡çº§æ¥è®¾è®¡ã€‚

### æ–¹æ¡ˆè®¾è®¡

å› ä¸ºè¦æ”¯æŒæ•°ä»¥ä¸‡è®¡çš„åœ¨çº¿ç©å®¶ï¼Œå¿…ç„¶è¦é‡‡å–åˆ†å¸ƒå¼çš„è®¾è®¡æ–¹æ¡ˆã€‚

### æ‹“æ‰‘ç»“æ„

æœåŠ¡ç«¯æ‹“æ‰‘ç»“æ„è®¾è®¡å¦‚ä¸‹

![æœåŠ¡ç«¯æ‹“æ‰‘ç»“æ„è®¾è®¡](../.gitbook/assets/2023-10-22232405.png)

å…¶ä¸­çš„åœ†åœˆä»£è¡¨æœåŠ¡ï¼Œåœˆå†…æ–‡å­—è¡¨æ˜æœåŠ¡çš„ç±»å‹å’Œç¼–å·ã€‚æ¯ä¸ªèŠ‚ç‚¹è¢«åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ç”¨è™šçº¿æ¡†èµ·æ¥çš„ä¸º`æœ¬åœ°æœåŠ¡`,æ–¹æ¡†å¤–çš„ç§°ä¸º`å…¨å±€æœåŠ¡`

| ç±»å‹     | è¯´æ˜                                                                                                          |
| -------- | ------------------------------------------------------------------------------------------------------------- |
| æœ¬åœ°æœåŠ¡ | åœ¨å•èŠ‚ç‚¹å†…æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯å®ƒä¸å…·å¤‡å…¨å±€å”¯ä¸€æ€§çš„æœåŠ¡                                                              |
| å…¨å±€æœåŠ¡ | åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸­éƒ½å…·æœ‰å”¯ä¸€æ€§çš„æœåŠ¡ï¼Œå¦‚å›¾ä¸­çš„ agentmgr,å¯ä»¥æŠŠå®ƒéƒ¨ç½²åˆ°èŠ‚ç‚¹ 1 æˆ–è€…èŠ‚ç‚¹ 2ï¼Œä½†æ˜¯åœ¨æ•´ä¸ªæ¶æ„ä¸­åªèƒ½æœ‰ä¸€ä¸ª |

### å„æœåŠ¡åŠŸèƒ½

æœåŠ¡ç«¯åŒ…å«äº† gatewayã€login ç­‰å¤šä¸ªç±»å‹çš„æœåŠ¡

- gateway

ç½‘å…³ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„æœåŠ¡ï¼Œå®¢æˆ·ç«¯ä¼šè¿æ¥æŸä¸ªç½‘å…³ï¼Œå¦‚æœç©å®¶å°šæœªç™»å½•ï¼Œç½‘å…³ä¼šæŠŠæ¶ˆæ¯è½¬å‘ç»™èŠ‚ç‚¹å†…æŸä¸ªç™»å½•æœåŠ¡å™¨ï¼Œ
ä»¥å¤„ç†è´¦å·æ ¡éªŒç­‰æ“ä½œï¼›å¦‚æœç™»å½•æˆåŠŸï¼Œåˆ™ä¼šæŠŠæ¶ˆæ¯è½¬å‘ç»™å®¢æˆ·ç«¯å¯¹åº”çš„ä»£ç†(agent),ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å¼€å¯å¤šä¸ªç½‘å…³ä»¥åˆ†æ‘Šæ€§èƒ½

- login

ç™»å½•æœåŠ¡ï¼Œç”¨äºå¤„ç†ç™»å½•é€»è¾‘çš„æœåŠ¡ï¼Œè´¦å·æ ¡éªŒï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å¼€å¯å¤šä¸ªç™»å½•æœåŠ¡åˆ†æ‘Šæ€§èƒ½ã€‚

- agent

ä»£ç†ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä¼šå¯¹åº”ä¸€ä¸ªä»£ç†æœåŠ¡(agent),è´Ÿè´£å¯¹åº”è§’è‰²çš„æ•°æ®åŠ è½½ï¼Œæ•°æ®å­˜å‚¨ï¼Œå•æœé€»è¾‘å¤„ç†ï¼ˆå¦‚å¼ºåŒ–è£…å¤‡ã€æˆå°±ç­‰ï¼‰ã€‚
å¤„äºæ€§èƒ½è€ƒè™‘ï¼Œagent å¿…é¡»ä¸å®ƒå¯¹åº”çš„å®¢æˆ·ç«¯è¿æ¥ï¼ˆå³å®¢æˆ·ç«¯è¿æ¥çš„ gatewayï¼‰å¤„äºåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚

- agentmgr

ç®¡ç†ä»£ç†(agent)çš„æœåŠ¡ï¼Œå®ƒä¼šè®°å½•æ¯ä¸ª agent æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œé¿å…ä¸åŒçš„å®¢æˆ·ç«¯ç™»å½•åŒä¸€ä¸ªè´¦å·

- nodemgr

èŠ‚ç‚¹ç®¡ç†ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå¼€å¯ä¸€ä¸ª nodemgr æœåŠ¡ï¼Œç”¨äºç®¡ç†è¯¥èŠ‚ç‚¹å’Œç›‘æ§æ€§èƒ½

- scene

åœºæ™¯æœåŠ¡ï¼Œå¤„ç†æˆ˜æ–—é€»è¾‘çš„æœåŠ¡ï¼Œæ¯ä¸€å±€æ¸¸æˆç”±ä¸€ä¸ªåœºæ™¯æœåŠ¡è´Ÿè´£ã€‚

### æ¶ˆæ¯æµç¨‹

ä»å®¢æˆ·ç«¯å‘èµ·è¿æ¥å¼€å§‹ï¼ŒæœåŠ¡ç«¯å†…éƒ¨çš„æ¶ˆæ¯å¤„ç†æµç¨‹å¦‚ä¸‹ï¼Œç®€åŒ–å¿½ç•¥äº† nodemgr

![æœåŠ¡ç«¯æ¶ˆæ¯å¤„ç†æµç¨‹](../.gitbook/assets/2023-10-22234252.png)

- ç™»å½•è¿‡ç¨‹

åœ¨ç¬¬ 1 é˜¶æ®µï¼Œå®¢æˆ·ç«¯è¿æ¥æŸä¸ª gatewayï¼Œç„¶åå‘é€ç™»å½•åè®®ï¼Œgateway å°†ç™»å½•åè®®è½¬å‘ç»™ loginï¼ˆé˜¶æ®µ 2ï¼‰ï¼Œæ ¡éªŒè´¦å·åï¼Œ
ç”± agentmgr åˆ›å»ºä¸å®¢æˆ·ç«¯å¯¹åº”çš„ agentï¼ˆé˜¶æ®µ 3 å’Œ 4ï¼‰å®Œæˆç™»å½•ã€‚å¦‚æœç©å®¶å·²ç»åœ¨å…¶ä»–èŠ‚ç‚¹ç™»å½•ï¼Œagentmgr ä¼šæŠŠå¦ä¸€ä¸ªå®¢æˆ·ç«¯ä¸‹çº¿å¤„ç†ã€‚

- æ¸¸æˆè¿‡ç¨‹

ç™»å½•æˆåŠŸåï¼Œå®¢æˆ·ç«¯çš„æ¶ˆæ¯ç»ç”± gateway è½¬å‘ç»™å¯¹åº”çš„ agentï¼ˆé˜¶æ®µ 5ï¼‰ï¼Œagent ä¼šå¤„ç†è§’è‰²çš„ä¸ªäººåŠŸèƒ½ï¼Œæ¯”å¦‚è´­ä¹°è£…å¤‡ã€æŸ¥çœ‹æˆå°±ç­‰ã€‚
å½“å®¢æˆ·ç«¯å‘é€å¼€å§‹æ¯”èµ›çš„åè®®æ—¶ï¼Œç¨‹åºä¼šé€‰æ‹©ä¸€ä¸ªåœºæ™¯æœåŠ¡å™¨ï¼Œè®©å®ƒå’Œ agent å…³è”ï¼Œå¤„ç†ä¸€åœºæˆ˜æ–—ï¼ˆé˜¶æ®µ 6ï¼‰ã€‚

### è®¾è®¡è¦ç‚¹

- gateway

gateway åªåšæ¶ˆæ¯è½¬å‘ï¼Œè§£åŒ…ï¼Œå¯ç”¨ gateway æœåŠ¡æ˜¯æœ‰å¥½å¤„çš„ï¼Œéš”ç¦»å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç³»ç»Ÿï¼Œä¾‹å¦‚è¦æ›´æ”¹å®¢æˆ·ç«¯åè®®ï¼ˆå¦‚ json æ”¹ä¸º protobufï¼‰
ä»…éœ€è¦ä¿®æ”¹ gatewayï¼Œä¸ä¼šå¯¹ç³»ç»Ÿå†…éƒ¨äº§ç”Ÿå½±å“ã€‚

é¢„ç•™æ–­çº¿é‡è¿åŠŸèƒ½ï¼Œå¦‚æœå®¢æˆ·ç«¯æ‰çº¿ï¼Œä»…å½±å“åˆ° gatewayï¼Œå¼•å…¥ gateway æ„å‘³ç€å®¢æˆ·ç«¯æ¶ˆæ¯éœ€ç»è¿‡ä¸€å±‚è½¬å‘ï¼Œä¼šå¸¦æ¥ä¸€å®šçš„å»¶è¿Ÿã€‚å°†åŒä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
çš„ gatewayã€loginã€agent ç½®äºåŒä¸€ä¸ªèŠ‚ç‚¹æœ‰åŠ©äºå‡å°‘å»¶è¿Ÿã€‚

- agent ä¸ scene çš„å…³ç³»

agent å¯ä»¥å’Œä»»æ„ä¸€ä¸ª scene é€šä¿¡ï¼Œä½†è·¨èŠ‚ç‚¹é€šä¿¡å¼€é”€æ¯”è¾ƒå¤§ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ”¯æ’‘æ•°åƒåç©å®¶ï¼Œè¶³ä»¥æ”¯æ’‘å„ç§æ®µä½çš„åŒ¹é…ï¼Œç©å®¶åº”å°½å¯èƒ½
è¿›å…¥åŒèŠ‚ç‚¹çš„æˆ˜æ–—åœºæ™¯æœåŠ¡å™¨ï¼ˆsceneï¼‰ã€‚

- agentmgr

agentmgr ä»…è®°å½• agent çš„çŠ¶æ€ã€å¤„ç†ç©å®¶ç™»å½•ï¼Œç™»å‡ºåŠŸèƒ½ï¼Œæ‰€æœ‰å¯¹å®ƒçš„è®¿é—®éƒ½ä»¥ç©å®¶ id ä¸ºç´¢å¼•ï¼Œagentmgr æ˜¯ä¸€ä¸ªå•èŠ‚ç‚¹ï¼Œä½†ä¹Ÿå¾ˆå®¹æ˜“æ‰©å±•ä¸ºåˆ†å¸ƒå¼ã€‚

### åˆ†å¸ƒå¼ç™»å½•æµç¨‹

å¤„ç†ç©å®¶çš„ç™»å½•ï¼Œæ˜¯æœåŠ¡ç«¯æ¡†æ¶çš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼Œè®©å®ƒä»¬ç›¸äº’é…ç½®ä¸äº§ç”Ÿé‡å¤æ˜¯ä¸€å¤§éš¾ç‚¹ã€‚

### å®Œæ•´çš„ç™»å½•æµç¨‹

çœ‹ä¸€ä¸‹ä¸‹é¢çš„å›¾å¤§è‡´å°±å¯ä»¥ç†è§£æ•´ä½“æµç¨‹ï¼Œè¿™æ¶‰åŠåˆ°é‡å¤ç™»å½•çš„åœºæ™¯

![ç™»å½•æ¶æ„æµç¨‹](../.gitbook/assets/2023-10-23001534.png)

### æ‰çº¿ç™»å‡ºæµç¨‹

å½“å®¢æˆ·ç«¯æ‰çº¿æ—¶ï¼Œç™»å‡ºæµç¨‹å¦‚å›¾æ‰€ç¤º

![æ‰çº¿ç™»å‡ºæµç¨‹å›¾](../.gitbook/assets/2023-10-23001706.png)

æ‰€æœ‰ä¸Šçº¿ä¸‹çº¿çš„è¯·æ±‚éƒ½è¦ç»è¿‡ agentmgrï¼Œç”±å®ƒè£å†³ï¼Œåªæœ‰â€œå·²åœ¨çº¿â€çŠ¶æ€çš„å®¢æˆ·ç«¯æ–¹å¯è¢«é¡¶æ›¿ä¸‹çº¿ï¼Œå¦‚æœå¤„äºâ€œç™»å½•ä¸­â€æˆ–â€œç™»å‡ºä¸­â€ï¼Œagentmgr ä¼šå‘Šè¯‰æ–°ç™»å½•çš„å®¢æˆ·ç«¯â€œå…¶ä»–ç©å®¶æ­£åœ¨å°è¯•ç™»å½•è¯¥è´¦å·ï¼Œè¯·ç¨åå†è¯•â€ã€‚è¿™æ ·è®¾è®¡å¯ä»¥å…å»è€ƒè™‘å¾ˆå¤šå¤æ‚æƒ…å†µã€‚

### å®ç° gateway

è¯·è§å¦‚ä¸‹éƒ¨åˆ†

### è¿æ¥ç±»å’Œç©å®¶ç±»

gateway éœ€è¦ä½¿ç”¨ä¸¤ä¸ªåˆ—è¡¨ï¼Œä¸€ä¸ªç”¨äºä¿å­˜å®¢æˆ·ç«¯è¿æ¥ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªç”¨äºè®°å½•å·²ç™»å½•ç©å®¶ä¿¡æ¯ï¼Œ"è®© gateway æŠŠå®¢æˆ·ç«¯å’Œ agent å…³è”èµ·æ¥"ï¼Œå³æ˜¯å°† è¿æ¥ä¿¡æ¯å’Œç©å®¶ä¿¡æ¯å…³è”èµ·æ¥ã€‚

```lua
-- service/gateway/init.lua
conns = {} --[fd] = conn
players = {} --[playerid] = gateplayer
-- è¿æ¥ç±»
function conn()
  local m = {
      fd = nil
      playerid = nil
  }
  return m
end
-- ç©å®¶ç±»
function gateplayer()
  local m = {
    playerid = nil,
    agent = nil,
    conn = nil
  }
end
```

åœ¨å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥åï¼Œç¨‹åºä¼šåˆ›å»ºä¸€ä¸ª conn å¯¹è±¡ï¼Œgateway ä¼šä»¥ fd ä¸ºç´¢å¼•å°†å…¶å­˜è¿› conns è¡¨ä¸­ã€‚conn å¯¹è±¡ä¼šä¿å­˜è¿æ¥çš„ fd
æ ‡è¯†ï¼Œä½† playerid å±æ€§ä¸ºç©ºï¼Œæ­¤æ—¶ gateway å¯ä»¥é€šè¿‡ conn å¯¹è±¡æ‰¾åˆ°è¿æ¥æ ‡è¯† fdï¼Œç»™å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚

![connså’Œplayersåˆ—è¡¨ç¤ºæ„å›¾](../.gitbook/assets/2023-10-24000212.png)

å½“ç©å®¶æˆåŠŸç™»é™†æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª gateplayer å¯¹è±¡ï¼ŒæœåŠ¡ç«¯æ‰ä¼šåˆ›å»ºè§’è‰²å¯¹è±¡(agent),gateway ä¼šä»¥ç©å®¶ id ä¸ºç´¢å¼•å°†å…¶å­˜å…¥
player è¡¨ä¸­ã€‚gateplayer å¯¹è±¡ä¼šä¿å­˜ playerid(ç©å®¶ id)ã€agentï¼ˆä»£ç†æœåŠ¡ idï¼‰ã€connï¼ˆå¯¹åº”çš„ conn å¯¹è±¡ï¼‰ã€‚

ç™»å½•åï¼Œgateway å¯ä»¥åšåˆ°åŒå‘æŸ¥æ‰¾

- å®¢æˆ·ç«¯å‘äº†æ¶ˆæ¯ï¼Œå¯ä»¥ç”±åº•å±‚ socketfd æ‰¾åˆ° conn å¯¹è±¡ï¼Œå†ç”± playerid å±æ€§æ‰¾åˆ° gateplayer å¯¹è±¡ï¼Œè¿›è€Œå¯ä»¥çŸ¥é“ä»£ç†æœåŠ¡ agent åœ¨å“ªé‡Œ
- è‹¥ agent å‘æ¥æ¶ˆæ¯ï¼Œåªè¦é™„å¸¦ç©å®¶ idï¼Œgateway å¯ä»¥ç”± playerid è·å–åˆ° gateplayer å¯¹è±¡è¿›è€Œå¯ä»¥æ‰¾åˆ° connï¼Œå¯ä»¥ä½¿ç”¨ fd è¿›è¡Œå‘é€

### æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥

é¦–å…ˆéœ€è¦å¼€å¯ socket çš„ç›‘å¬ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œstart æ–¹æ³•çš„å›è°ƒå‡½æ•° connect è¢«è°ƒç”¨

```lua
--service/gateway/init.lua
local socket = require "skynet.socket"
local runconfig = require "runconfig"
function s.init()
  local node = skynet.getenv("node")
  local nodecfg = runconfig[node]
  local port = nodecfg.gateway[s.id].port
  local listenfd = socket.listen("0.0.0.0", port)
  skynet.error("Listen socket :", "0.0.0.0", port)
  socket.start(listenfd, connect)
end
--æœ‰æ–°è¿æ¥æ—¶çš„å¤„ç†
local connect = function(fd, addr)
  print("connect from " .. addr .. " " .. fd)
  local c = conn()
  conns[fd] = c
  c.fd = fd
  skynet.fork(recv_loop, fd)
end
```

recv_loop è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯

```lua
-- service/gateway/init.lua
--æ¯ä¸€æ¡è¿æ¥æ¥æ”¶æ•°æ®å¤„ç†
--åè®®æ ¼å¼cmd,arg1,arg2,...#
local recv_loop = function(fd)
  socket.start(fd)
  skynet.error("socket connected" ..fd)
  local readbuff = ""
  while true do
    local recvstr = socket.read(fd)
    if recvstr then
      readbuff = readbuff..recvstr
      readbuff = process_buff(fd, readbuff)
    else
      skynet.error("socket close" ..fd)
      disconnect(fd)
      socket.close(fd)
      return
    end
  end
end
```

é€šè¿‡æ‹¼æ¥ Lua å­—ç¬¦ä¸²å®ç°ç¼“å†²åŒºæ˜¯ä¸€ç§ç®€å•çš„åšæ³•ï¼Œå®ƒå¯èƒ½å¸¦æ¥ GCï¼ˆåƒåœ¾å›æ”¶ï¼‰çš„è´Ÿæ‹…ã€‚

![å¤„ç†å®¢æˆ·ç«¯è¿æ¥çš„ç¤ºæ„å›¾](../.gitbook/assets/2023-10-24002047.png)

### å¤„ç†å®¢æˆ·ç«¯åè®®

æœåŠ¡ç«¯æ¥æ”¶åˆ°æ•°æ®åå°±ä¼šè°ƒç”¨ process_buff,å¹¶æŠŠç¼“å†²åŒºä¼ ç»™å®ƒï¼Œprocess_buf ä¼šå®ç°æ¶ˆæ¯çš„åˆ‡åˆ†å·¥ä½œ.

```lua
--service/gateway/init.lua
local process_buff = function(fd, readbuff)
  while true do
    local msgstr, rest = string.match(readbuff, "(.-)\r\n(.*)")
    if msgstr then
      readbuff = rest
      process_msg(fd, msgstr)
    else
      return readbuff
    end
end
```

è¿™å°±æ˜¯ä¸ªä» buffer ä¸­è§£æåè®®çš„æµç¨‹ï¼Œå¹¶ä¸éš¾ç†è§£

### ç¼–ç å’Œè§£ç 

å¯ä»¥å°è£…è‡ªå·±çš„å·¥å…·å‡½æ•°ï¼Œè¿›è¡Œåè®®çš„è§£åŒ…å°åŒ…æ“ä½œï¼Œæ­¤å¤„ä¸å†è¯¦ç»†å±•å¼€

### æ¶ˆæ¯åˆ†å‘

å…ˆçœ‹ä¸‹ä»£ç ï¼Œè¦åšçš„å°±æ˜¯ æ¶ˆæ¯è§£ç ã€å¦‚æœå°šæœªç™»é™†ã€å¦‚æœå·²ç»ç™»å½•ã€å°†æ¶ˆæ¯å‘å¾€ agent

![process_msgæ–¹æ³•ç¤ºæ„å›¾](../.gitbook/assets/2023-10-24003137.png)

```lua
local process_msg = function(fd, msgstr)
    local cmd, msg = str_unpack(msgstr)
    skyn et.error("recv "..fd.." ["..cmd.."] {"..table.concat( msg, ",").."}")

    local conn = conns[fd]
    local playerid = conn.playerid
    --å°šæœªå®Œæˆç™»å½•æµç¨‹
    if not playerid then
        local node = skynet.getenv("node")
        local nodecfg = runconfig[node]
        -- éšæœºä¸€ä¸ªloginèŠ‚ç‚¹
        local loginid = math.random(1, #nodecfg.login)
        local login = "login"..loginid
        -- å‘å¾€ç›®æ ‡login
        skynet.send(login, "lua", "client", fd, cmd, msg)
    --å®Œæˆç™»å½•æµç¨‹
    else
        local gplayer = players[playerid]
        local agent = gplayer.agent
        skynet.send(agent, "lua", "client", cmd, msg)
    end
end
```

### å‘é€æ¶ˆæ¯æ¥å£

gateway å°†æ¶ˆæ¯ä¼ ç»™ login æˆ– agentï¼Œlogin æˆ– agent ä¹Ÿéœ€è¦ç»™å®¢æˆ·ç«¯å›åº”ã€‚æ¯”ä¾‹ï¼Œåœ¨å®¢æˆ·ç«¯å‘é€ç™»å½•åè®®ï¼Œlogin æ ¡éªŒå¤±è´¥åï¼Œ
è¦ç»™å®¢æˆ·ç«¯å›åº” è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œåˆ™éœ€è¦ login å‘å¾€ gateway å†ç”± gateway å‘å¾€ clientã€‚

![loginç»™å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯çš„è¿‡ç¨‹](../.gitbook/assets/2023-10-24003456.png)

```lua
-- ä»sourceå‘æ¥ å‘ç»™fd æ¶ˆæ¯ä¸ºmsg
s.resp.send_by_fd = function(source, fd, msg)
    if not conns[fd] then
        return
    end

    local buff = str_pack(msg[1], msg)
    skynet.error("send "..fd.." ["..msg[1].."] {"..table.concat( msg, ",").."}")
    socket.write(fd, buff)
end

-- æ ¹æ®playeridç»™clientå‘é€æ¶ˆæ¯
s.resp.send = function(source, playerid, msg)
    local gplayer = players[playerid]
    if gplayer == nil then
        return
    end
    local c = gplayer.conn
    if c == nil then
        return
    end

    s.resp.send_by_fd(nil, c.fd, msg)
end
```

### ç¡®è®¤ç™»å½•æ¥å£

åœ¨å®Œæˆç™»å½•æµç¨‹åï¼Œlogin ä¼šé€šçŸ¥ gatewayï¼Œè®©å®ƒæŠŠå®¢æˆ·ç«¯è¿æ¥å’Œæ–° agent å…³è”èµ·æ¥

```lua
s.resp.sure_agent = function(source, fd, playerid, agent)
    local conn = conns[fd]
    if not conn then --ç™»å½•è¿‡ç¨‹ä¸­å·²ç»ä¸‹çº¿
        skynet.call("agentmgr", "lua", "reqkick", playerid, "æœªå®Œæˆç™»å½•å³ä¸‹çº¿")
        return false
    end

    conn.playerid = playerid

    local gplayer = gateplayer()
    gplayer.playerid = playerid
    gplayer.agent = agent
    gplayer.conn = conn
    players[playerid] = gplayer

    return true
end
```

sure_agent çš„åŠŸèƒ½æ˜¯å°† fd å’Œ playerid å…³è”èµ·æ¥ï¼Œå®ƒä¼šå…ˆæŸ¥æ‰¾è¿æ¥å¯¹è±¡ connï¼Œå†åˆ›å»º gateplayer å¯¹è±¡ gplayerï¼Œå¹¶è®¾ç½®å±æ€§ã€‚

### ç™»å‡ºåè®®

ç©å®¶æœ‰ä¸¤ç§ç™»å‡ºæƒ…å†µï¼Œä¸€ç§ä¸ºå®¢æˆ·ç«¯æ‰çº¿æˆ–è€…è‡ªä¸»çº¿ä¸‹ï¼Œå¦ä¸€ç§æ˜¯è¢«é¡¶æ›¿ä¸‹çº¿ã€‚å¦‚æœå®¢æˆ·ç«¯æ‰çº¿ gateway ä¼šå‘ agentmgr å‘é€ä¸‹çº¿è¯·æ±‚ï¼Œç”± agentmgr ä»²è£ã€‚

```lua
--service/gateway/init.lua
local disconnect = function(fd)
    local c = conns[fd]
    if not c then
        return
    end

    local playerid = c.playerid
    --è¿˜æ²¡å®Œæˆç™»å½•
    if not playerid then
        return
    --å·²åœ¨æ¸¸æˆä¸­
    else
        -- players[playerid] = nil -- å°†ç©å®¶çš„gateplayerå¯¹è±¡åˆ é™¤ï¼Œå…¶å®é‡Œåº”å½“åœ¨agentmgrå›åŒ…ååˆ é™¤
        local reason = "æ–­çº¿"
        skynet.call("agentmgr", "lua", "reqkick", playerid, reason)
    end
end
```

å¦‚æœ agentmgr ä»²è£é€šè¿‡ï¼Œæˆ–è€… agentmgr æƒ³ç›´æ¥æŠŠç©å®¶è¸¢ä¸‹çº¿ï¼Œåœ¨ä¿å­˜æ•°æ®åï¼Œä¼šé€šçŸ¥ gateway åšæ”¶å°¾å·¥ä½œ,åˆ æ‰ç©å®¶çš„ conn å’Œ gateplayer å¯¹è±¡

```lua
s.resp.kick = function(source, playerid)
    local gplayer = players[playerid]
    if not gplayer then
        return
    end

    local c = gplayer.conn
    players[playerid] = nil

    if not c then
        return
    end
    conns[c.fd] = nil
    disconnect(c.fd)
    socket.close(c.fd)
end
```

gateway å¤§è‡´å°±æ˜¯è¿™æ ·ï¼Œç†è®ºè¿™æ ·è®¾è®¡æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ç”¨è¿˜éœ€è¦å¾ˆå¤šæ·±æ€ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ˜¯ç”¨æ¥ï¼Œå­¦ä¹ ï¼Œå¾ˆä¸é”™å•¦ï¼Œä½ å¾ˆæ£’çš„åŠ æ²¹ã€‚

### å®ç° login

ç™»å½•æœåŠ¡ï¼Œå¯¹äºæ­¤æœåŠ¡å¯ä»¥çœ‹ä»¥å‰çš„ç™»å½•æµç¨‹ã€‚

### ç™»å½•åè®®

å®¢æˆ·ç«¯è‚¯å®šè¦å‘è´¦å·å¯†ç ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°ç™»å½•åè®®åä¼šåšå‡ºå›åº”ï¼Œgateway æŒ‘ä¸€ä¸ª login å»éªŒè¯ï¼Œåœ¨ login è¿”å›åŒ…ç»™ gateway æ—¶ï¼Œgateway åº”è¯¥æç¤ºå®¢æˆ·ç«¯ï¼Œå¦‚è´¦å·æˆ–å¯†ç é”™è¯¯ï¼Œå…¶ä»–ç©å®¶æ­£åœ¨å°è¯•ç™»å½•è¯¥è´¦å·è¯·ç¨åå†è¯•ã€‚

### ç™»å½•æµç¨‹å¤„ç†

gateway ä¼šå°†å®¢æˆ·ç«¯åè®®ä»¥ client æ¶ˆæ¯çš„å½¢å¼è½¬å‘ç»™ login æœåŠ¡ï¼Œlogin æœåŠ¡ä¼šå…ˆæ ¡éªŒå®¢æˆ·ç«¯å‘æ¥çš„ç”¨æˆ·åå¯†ç ï¼Œå†ä½œä¸º
gateway å’Œ agentmgr çš„ä¸­ä»‹ï¼Œç­‰å¾… agentmgr åˆ›å»ºä»£ç†æœåŠ¡ã€‚

1. æ ¡éªŒç”¨æˆ·åå¯†ç ï¼šè¿™ä¸ªè¿‡ç¨‹å¯èƒ½æ˜¯æŸ¥è¯¢æ•°æ®åº“æˆ–è€…å‘å¹³å° SDK è¿›è¡ŒéªŒè¯
2. ç»™ agentmgr å‘é€ reqloginï¼Œè¯·æ±‚ç™»å½•ï¼Œreqlogin ä¼šå›åº”ä¸¤ä¸ªå€¼ä¸€ä¸ªå€¼ä»£è¡¨æ˜¯å¦æˆåŠŸï¼Œä¸€ä¸ªå€¼ä¸º agent ä»£è¡¨å·²åˆ›å»ºçš„ä»£ç†æœåŠ¡ id
3. ç»™ gate å‘é€ sure_agent
4. å¦‚æœå…¨éƒ¨è¿‡ç¨‹æˆåŠŸæ‰§è¡Œï¼Œlogin æœåŠ¡ä¼šç»™å®¢æˆ·ç«¯å›åº”æˆåŠŸæ¶ˆæ¯ã€‚

è¯¦ç»†çš„è¿˜æ˜¯çœ‹æœ¬ç« ä»¥å‰çš„ å®Œæ•´çš„ç™»å½•æµç¨‹ éƒ¨åˆ†çš„å›¾è§£å§ã€‚

```lua
--service/login/init.lua
s.client.login = function(fs, msg, source)
  local playerid = tonumber(msg[2])
  local pw = tonumber(msg[3])
  local gate = source
  node = skynet.getenv("node")
  --æ ¡éªŒç”¨æˆ·åå¯†ç 
  if pw ~= 123 then
    return {"login", 1, "å¯†ç é”™è¯¯"}
  end
  --å‘ç»™agentmgr
  local isok, agent = skynet.call("agentmgr", "lua", "reqlogin", playerid, node, gate)
  if not isok then
    return {"login", 1, "è¯·æ±‚mgrå¤±è´¥"}
  end
  --å›åº”gate
  local isok = skynet.call(gate, "lua", "sure_agent", fd, playerid, agent)
  if not isok then
    return {"login", 1, "gateæ³¨å†Œå¤±è´¥"}
  end
  skynet.error("login succ"..playerid)
  return {"login", 0, "ç™»å½•æˆåŠŸ"}
end
```

ä»£ç å½“ä¼ªä»£ç çœ‹å°±è¡Œäº†ï¼Œä¸»æ‰“ä¸€ä¸ªä¸šåŠ¡å­¦ä¹ ä½œç”¨

### å®ç° agentmgr

agentmgr æ˜¯ç®¡ç† agent çš„æœåŠ¡ï¼Œå®ƒæ˜¯ç™»å½•è¿‡ç¨‹çš„ä»²è£æœåŠ¡ï¼Œæ§åˆ¶ç€ç™»å½•è¿‡ç¨‹ã€‚agentmgr ä¸­å«æœ‰ä¸€ä¸ªåˆ—è¡¨ playersï¼Œé‡Œé¢ä¿å­˜ç€æ‰€æœ‰ç©å®¶çš„åœ¨çº¿çŠ¶æ€ã€‚

### ç©å®¶ç±»

ç™»å½•æµç¨‹ä¸­ï¼Œç©å®¶ä¼šæœ‰ â€œç™»å½•ä¸­â€ã€â€œæ¸¸æˆä¸­â€ã€â€œç™»å‡ºä¸­â€ä¸‰ç§çŠ¶æ€ã€‚

```lua
STATUS = {
  LOGIN = 2,
  GAME = 3,
  LOGOUT = 4
}
--ç©å®¶åˆ—è¡¨
local players={}
--ç©å®¶ç±»
function mgrplayer()
  local m = {
    playerid = nil, -- ç©å®¶id
    node = nil, -- è¯¥ç©å®¶å¯¹åº”gatewayå’Œagentæ‰€åœ¨çš„èŠ‚ç‚¹
    agent = nil, -- è¯¥ç©å®¶å¯¹agentæœåŠ¡çš„id
    status = nil, -- çŠ¶æ€
    gate = nil -- è¯¥ç©å®¶å¯¹åº”gatewayçš„id
  }
end
```

![mgrplayerå¯¹è±¡çš„ç¤ºæ„å›¾](../.gitbook/assets/2023-10-27002821.png)

### è¯·æ±‚ç™»å½•æ¥å£

login æœåŠ¡ä¼šå‘ agentmgr è¯·æ±‚ç™»å½•(reqlogin)

1. ç™»å½•ä»²è£ï¼Œåˆ¤æ–­ç©å®¶æ˜¯å¦å·²ç»ç™»å½•
2. é¡¶æ›¿å·²åœ¨çº¿ç©å®¶ï¼Œå¦‚æœè¯¥è§’è‰²å·²åœ¨çº¿ï¼Œéœ€è¦å…ˆæŠŠå®ƒè¸¢ä¸‹çº¿
3. è®°å½•åœ¨çº¿ä¿¡æ¯ï¼Œå°†æ–°å»ºçš„ mgrplayer å¯¹è±¡è®°å½•ä¸ºç™»é™†ä¸­çŠ¶æ€
4. è®© nodemgr åˆ›å»º agent æœåŠ¡
5. ç™»å½•å®Œæˆï¼Œè®¾ç½® mgrplayer ä¸ºæ¸¸æˆä¸­çŠ¶æ€ï¼Œå¹¶è¿”å› true ä¸ agent æœåŠ¡çš„ id

![å½“å‰å®Œæˆçš„ç™»å½•æµç¨‹æ ‡æ³¨å›¾](../.gitbook/assets/2023-10-27003600.png)

```lua
s.resp.reqlogin = function(source, playerid, node, gate)
    local mplayer = players[playerid]
    --ç™»å½•è¿‡ç¨‹ç¦æ­¢é¡¶æ›¿
    if mplayer and mplayer.status == STATUS.LOGOUT then
        skynet.error("reqlogin fail, at status LOGOUT " ..playerid )
        return false
    end
    if mplayer and mplayer.status == STATUS.LOGIN then
        skynet.error("reqlogin fail, at status LOGIN " ..playerid)
        return false
    end
    --åœ¨çº¿ï¼Œé¡¶æ›¿
    if mplayer then
        local pnode = mplayer.node
        local pagent = mplayer.agent
        local pgate = mplayer.gate
        mplayer.status = STATUS.LOGOUT,
        s.call(pnode, pagent, "kick")
        s.send(pnode, pagent, "exit")
        s.send(pnode, pgate, "send", playerid, {"kick","é¡¶æ›¿ä¸‹çº¿"})
        s.call(pnode, pgate, "kick", playerid)
    end
    --ä¸Šçº¿
    local player = mgrplayer()
    player.playerid = playerid
    player.node = node
    player.gate = gate
    player.agent = nil
    player.status = STATUS.LOGIN
    players[playerid] = player
    local agent = s.call(node, "nodemgr", "newservice", "agent", "agent", playerid)
    player.agent = agent
    player.status = STATUS.GAME
    return true, agent
end
```

### è¯·æ±‚ç™»å‡ºæ¥å£

é™¤äº†ç™»å½•ï¼Œagentmgr è¿˜è´Ÿè´£ç™»å‡ºçš„ä»²è£ã€‚agentmgr ä¼šå…ˆå‘é€ kick è®© agent å¤„ç†ä¿å­˜æ•°æ®çš„äº‹æƒ…ï¼Œå†å‘é€ exit è®© agent é€€å‡ºæœåŠ¡ï¼Œç”±äºä¿å­˜æ•°æ®éœ€è¦ä¸€å°æ®µæ—¶é—´ï¼Œå› æ­¤ mgrplayer ä¼šä¿å­˜ä¸€å°æ®µæ—¶é—´çš„ LOGOUT çŠ¶æ€ã€‚

```lua
-- service/agentmgr/init.lua
s.resp.reqkick = function(source, playerid, reason)
    local mplayer = players[playerid]
    if not mplayer then
        return false
    end

    if mplayer.status ~= STATUS.GAME then
        return false
    end

    local pnode = mplayer.node
    local pagent = mplayer.agent
    local pgate = mplayer.gate
    mplayer.status = STATUS.LOGOUT

    s.call(pnode, pagent, "kick") -- callåŒæ­¥
    s.send(pnode, pagent, "exit") -- sendå¼‚æ­¥
    s.send(pnode, pgate, "kick", playerid) --å¼‚æ­¥è°ƒç”¨
    players[playerid] = nil

    return true
end
```

### å®ç° nodemgr

### å®ç° agent å•æœº

### æµ‹è¯•ç™»å½•æµç¨‹

### æˆ˜æ–—æµç¨‹

### åœºæ™¯æœåŠ¡

### å®ç° agent è·¨æœåŠ¡å™¨
